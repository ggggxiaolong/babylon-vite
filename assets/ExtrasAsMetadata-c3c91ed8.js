import{L as U,D as Fs,F as Vs,I as ks,J as Us,K as Gs,T as N,a as ms,O as W,M as Hs,N as Is,R as Ks,P as Ws,Q as q,U as js,V as T,W as Ys,X as v,Y as ie,Z as Ns,$ as qs,a0 as Js,a1 as rs,a2 as os,a3 as L,a4 as Z,a5 as oe,a6 as y,a7 as J,H as Ms,a8 as is,a9 as as,aa as ls,ab as Ce,ac as vs,ad as ce,ae as Ae,af as zs,ag as Xs,ah as cs,ai as Zs,aj as x,ak as ps,al as Qs,am as et,an as st,ao as tt,ap as nt,aq as V,ar as rt,as as ot,at as X,au as it,av as at,aw as lt,ax as ct,ay as dt,az as As,aA as ht,aB as ut,aC as ft}from"./nativeXRFrame-7c0cc334.js";class ds{constructor(e,s,t){this.frame=e,this.action=s,this.onlyOnce=t,this.isDone=!1}_clone(){return new ds(this.frame,this.action,this.onlyOnce)}}class _t{constructor(e,s,t){if(this.loop=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._volume=1,this.isPlaying=!1,this.isPaused=!1,this._sounds=[],this._weights=[],s.length!==t.length)throw new Error("Sounds length does not equal weights length");this.loop=e,this._weights=t;let n=0;for(const o of t)n+=o;const r=n>0?1/n:0;for(let o=0;o<this._weights.length;o++)this._weights[o]*=r;this._sounds=s;for(const o of this._sounds)o.onEndedObservable.add(()=>{this._onended()})}get directionalConeInnerAngle(){return this._coneInnerAngle}set directionalConeInnerAngle(e){if(e!==this._coneInnerAngle){if(this._coneOuterAngle<e){U.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=e;for(const s of this._sounds)s.directionalConeInnerAngle=e}}get directionalConeOuterAngle(){return this._coneOuterAngle}set directionalConeOuterAngle(e){if(e!==this._coneOuterAngle){if(e<this._coneInnerAngle){U.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneOuterAngle=e;for(const s of this._sounds)s.directionalConeOuterAngle=e}}get volume(){return this._volume}set volume(e){if(e!==this._volume)for(const s of this._sounds)s.setVolume(e)}_onended(){this._currentIndex!==void 0&&(this._sounds[this._currentIndex].autoplay=!1),this.loop&&this.isPlaying?this.play():this.isPlaying=!1}pause(){this.isPaused=!0,this._currentIndex!==void 0&&this._sounds[this._currentIndex].pause()}stop(){this.isPlaying=!1,this._currentIndex!==void 0&&this._sounds[this._currentIndex].stop()}play(e){if(!this.isPaused){this.stop();const t=Math.random();let n=0;for(let r=0;r<this._weights.length;r++)if(n+=this._weights[r],t<=n){this._currentIndex=r;break}}const s=this._sounds[this._currentIndex];s.isReady()?s.play(0,this.isPaused?void 0:e):s.autoplay=!0,this.isPlaying=!0,this.isPaused=!1}}class hs extends Fs{constructor(e,s,t,n=5,r=0,o=!1,a=!1,l=3,c=null){super("",e),this._texture=e.getEngine().createRawCubeTexture(s,t,n,r,o,a,l,c)}update(e,s,t,n,r=null){this._texture.getEngine().updateRawCubeTexture(this._texture,e,s,t,n,r)}updateRGBDAsync(e,s=null,t=.8,n=0){return Vs(this._texture,e,s,t,n).then(()=>{})}clone(){return ks.Clone(()=>{const e=this.getScene(),s=this._texture,t=new hs(e,s._bufferViewArray,s.width,s.format,s.type,s.generateMipMaps,s.invertY,s.samplingMode,s._compression);return s.source===Us.CubeRawRGBD&&t.updateRGBDAsync(s._bufferViewArrayArray,s._sphericalPolynomial,s._lodGenerationScale,s._lodGenerationOffset),t},this)}}class ue{get resolve(){return this._resolve}get reject(){return this._reject}constructor(){this.promise=new Promise((e,s)=>{this._resolve=e,this._reject=s})}}class Oe{constructor(e){this.byteOffset=0,this.buffer=e}loadAsync(e){return this.buffer.readAsync(this.byteOffset,e).then(s=>{this._dataView=new DataView(s.buffer,s.byteOffset,s.byteLength),this._dataByteOffset=0})}readUint32(){const e=this._dataView.getUint32(this._dataByteOffset,!0);return this._dataByteOffset+=4,this.byteOffset+=4,e}readUint8Array(e){const s=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._dataByteOffset,e);return this._dataByteOffset+=e,this.byteOffset+=e,s}readString(e){return Gs(this.readUint8Array(e))}skipBytes(e){this._dataByteOffset+=e,this.byteOffset+=e}}function we(i,e,s,t){const n={externalResourceFunction:r=>t(r).then(o=>new Uint8Array(o))};return s&&(n.uri=e==="file:"?s:e+s),i instanceof ArrayBuffer?GLTFValidator.validateBytes(new Uint8Array(i),n):GLTFValidator.validateString(i,n)}function mt(){const i=[];onmessage=e=>{const s=e.data;switch(s.id){case"init":{importScripts(s.url);break}case"validate":{we(s.data,s.rootUrl,s.fileName,t=>new Promise((n,r)=>{const o=i.length;i.push({resolve:n,reject:r}),postMessage({id:"getExternalResource",index:o,uri:t})})).then(t=>{postMessage({id:"validate.resolve",value:t})},t=>{postMessage({id:"validate.reject",reason:t})});break}case"getExternalResource.resolve":{i[s.index].resolve(s.value);break}case"getExternalResource.reject":{i[s.index].reject(s.reason);break}}}}class Ls{static ValidateAsync(e,s,t,n){return typeof Worker=="function"?new Promise((r,o)=>{const a=`${we}(${mt})()`,l=URL.createObjectURL(new Blob([a],{type:"application/javascript"})),c=new Worker(l),d=u=>{c.removeEventListener("error",d),c.removeEventListener("message",h),o(u)},h=u=>{const f=u.data;switch(f.id){case"getExternalResource":{n(f.uri).then(m=>{c.postMessage({id:"getExternalResource.resolve",index:f.index,value:m},[m])},m=>{c.postMessage({id:"getExternalResource.reject",index:f.index,reason:m})});break}case"validate.resolve":{c.removeEventListener("error",d),c.removeEventListener("message",h),r(f.value),c.terminate();break}case"validate.reject":c.removeEventListener("error",d),c.removeEventListener("message",h),o(f.reason),c.terminate()}};c.addEventListener("error",d),c.addEventListener("message",h),c.postMessage({id:"init",url:this.Configuration.url}),c.postMessage({id:"validate",data:e,rootUrl:s,fileName:t})}):(this._LoadScriptPromise||(this._LoadScriptPromise=N.LoadScriptAsync(this.Configuration.url)),this._LoadScriptPromise.then(()=>we(e,s,t,n)))}}Ls.Configuration={url:"https://preview.babylonjs.com/gltf_validator.js"};function gs(i,e,s){try{return Promise.resolve(new Uint8Array(i,e,s))}catch(t){return Promise.reject(t)}}var me;(function(i){i[i.AUTO=0]="AUTO",i[i.FORCE_RIGHT_HANDED=1]="FORCE_RIGHT_HANDED"})(me||(me={}));var le;(function(i){i[i.NONE=0]="NONE",i[i.FIRST=1]="FIRST",i[i.ALL=2]="ALL"})(le||(le={}));var z;(function(i){i[i.LOADING=0]="LOADING",i[i.READY=1]="READY",i[i.COMPLETE=2]="COMPLETE"})(z||(z={}));class ${constructor(){this.onParsedObservable=new W,this.coordinateSystemMode=me.AUTO,this.animationStartMode=le.FIRST,this.compileMaterials=!1,this.useClipPlane=!1,this.compileShadowGenerators=!1,this.transparencyAsCoverage=!1,this.useRangeRequests=!1,this.createInstances=!0,this.alwaysComputeBoundingBox=!1,this.loadAllMaterials=!1,this.loadOnlyMaterials=!1,this.skipMaterials=!1,this.useSRGBBuffers=!0,this.targetFps=60,this.alwaysComputeSkeletonRootNode=!1,this.preprocessUrlAsync=e=>Promise.resolve(e),this.onMeshLoadedObservable=new W,this.onSkinLoadedObservable=new W,this.onTextureLoadedObservable=new W,this.onMaterialLoadedObservable=new W,this.onCameraLoadedObservable=new W,this.onCompleteObservable=new W,this.onErrorObservable=new W,this.onDisposeObservable=new W,this.onExtensionLoadedObservable=new W,this.validate=!1,this.onValidatedObservable=new W,this._loader=null,this._state=null,this._requests=new Array,this.name="gltf",this.extensions={".gltf":{isBinary:!1},".glb":{isBinary:!0}},this.onLoaderStateChangedObservable=new W,this._logIndentLevel=0,this._loggingEnabled=!1,this._log=this._logDisabled,this._capturePerformanceCounters=!1,this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled}set onParsed(e){this._onParsedObserver&&this.onParsedObservable.remove(this._onParsedObserver),this._onParsedObserver=this.onParsedObservable.add(e)}set onMeshLoaded(e){this._onMeshLoadedObserver&&this.onMeshLoadedObservable.remove(this._onMeshLoadedObserver),this._onMeshLoadedObserver=this.onMeshLoadedObservable.add(e)}set onTextureLoaded(e){this._onTextureLoadedObserver&&this.onTextureLoadedObservable.remove(this._onTextureLoadedObserver),this._onTextureLoadedObserver=this.onTextureLoadedObservable.add(e)}set onMaterialLoaded(e){this._onMaterialLoadedObserver&&this.onMaterialLoadedObservable.remove(this._onMaterialLoadedObserver),this._onMaterialLoadedObserver=this.onMaterialLoadedObservable.add(e)}set onCameraLoaded(e){this._onCameraLoadedObserver&&this.onCameraLoadedObservable.remove(this._onCameraLoadedObserver),this._onCameraLoadedObserver=this.onCameraLoadedObservable.add(e)}set onComplete(e){this._onCompleteObserver&&this.onCompleteObservable.remove(this._onCompleteObserver),this._onCompleteObserver=this.onCompleteObservable.add(e)}set onError(e){this._onErrorObserver&&this.onErrorObservable.remove(this._onErrorObserver),this._onErrorObserver=this.onErrorObservable.add(e)}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set onExtensionLoaded(e){this._onExtensionLoadedObserver&&this.onExtensionLoadedObservable.remove(this._onExtensionLoadedObserver),this._onExtensionLoadedObserver=this.onExtensionLoadedObservable.add(e)}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled!==e&&(this._loggingEnabled=e,this._loggingEnabled?this._log=this._logEnabled:this._log=this._logDisabled)}get capturePerformanceCounters(){return this._capturePerformanceCounters}set capturePerformanceCounters(e){this._capturePerformanceCounters!==e&&(this._capturePerformanceCounters=e,this._capturePerformanceCounters?(this._startPerformanceCounter=this._startPerformanceCounterEnabled,this._endPerformanceCounter=this._endPerformanceCounterEnabled):(this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled))}set onValidated(e){this._onValidatedObserver&&this.onValidatedObservable.remove(this._onValidatedObserver),this._onValidatedObserver=this.onValidatedObservable.add(e)}dispose(){this._loader&&(this._loader.dispose(),this._loader=null);for(const e of this._requests)e.abort();this._requests.length=0,delete this._progressCallback,this.preprocessUrlAsync=e=>Promise.resolve(e),this.onMeshLoadedObservable.clear(),this.onSkinLoadedObservable.clear(),this.onTextureLoadedObservable.clear(),this.onMaterialLoadedObservable.clear(),this.onCameraLoadedObservable.clear(),this.onCompleteObservable.clear(),this.onExtensionLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(void 0),this.onDisposeObservable.clear()}loadFile(e,s,t,n,r,o){this._progressCallback=n;const a=s.name?"file:":N.GetFolderPath(s),l=s.name||N.GetFilename(s);if(r){if(this.useRangeRequests){this.validate&&U.Warn("glTF validation is not supported when range requests are enabled");const c={abort:()=>{},onCompleteObservable:new W},d={readAsync:(h,u)=>new Promise((f,m)=>{this._loadFile(e,s,g=>{f(new Uint8Array(g))},!0,g=>{m(g)},g=>{g.setRequestHeader("Range",`bytes=${h}-${h+u-1}`)})}),byteLength:0};return this._unpackBinaryAsync(new Oe(d)).then(h=>{c.onCompleteObservable.notifyObservers(c),t(h)},o?h=>o(void 0,h):void 0),c}return this._loadFile(e,s,c=>{this._validate(e,c,a,l),this._unpackBinaryAsync(new Oe({readAsync:(d,h)=>gs(c,d,h),byteLength:c.byteLength})).then(d=>{t(d)},o?d=>o(void 0,d):void 0)},!0,o)}return this._loadFile(e,s,c=>{this._validate(e,c,a,l),t({json:this._parseJson(c)})},r,o)}importMeshAsync(e,s,t,n,r,o){return Promise.resolve().then(()=>(this.onParsedObservable.notifyObservers(t),this.onParsedObservable.clear(),this._log(`Loading ${o||""}`),this._loader=this._getLoader(t),this._loader.importMeshAsync(e,s,null,t,n,r,o)))}loadAsync(e,s,t,n,r){return Promise.resolve().then(()=>(this.onParsedObservable.notifyObservers(s),this.onParsedObservable.clear(),this._log(`Loading ${r||""}`),this._loader=this._getLoader(s),this._loader.loadAsync(e,s,t,n,r)))}loadAssetContainerAsync(e,s,t,n,r){return Promise.resolve().then(()=>{this.onParsedObservable.notifyObservers(s),this.onParsedObservable.clear(),this._log(`Loading ${r||""}`),this._loader=this._getLoader(s);const o=new Hs(e),a=[];this.onMaterialLoadedObservable.add(h=>{a.push(h)});const l=[];this.onTextureLoadedObservable.add(h=>{l.push(h)});const c=[];this.onCameraLoadedObservable.add(h=>{c.push(h)});const d=[];return this.onMeshLoadedObservable.add(h=>{h.morphTargetManager&&d.push(h.morphTargetManager)}),this._loader.importMeshAsync(null,e,o,s,t,n,r).then(h=>(Array.prototype.push.apply(o.geometries,h.geometries),Array.prototype.push.apply(o.meshes,h.meshes),Array.prototype.push.apply(o.particleSystems,h.particleSystems),Array.prototype.push.apply(o.skeletons,h.skeletons),Array.prototype.push.apply(o.animationGroups,h.animationGroups),Array.prototype.push.apply(o.materials,a),Array.prototype.push.apply(o.textures,l),Array.prototype.push.apply(o.lights,h.lights),Array.prototype.push.apply(o.transformNodes,h.transformNodes),Array.prototype.push.apply(o.cameras,c),Array.prototype.push.apply(o.morphTargetManagers,d),o))})}canDirectLoad(e){return e.indexOf("asset")!==-1&&e.indexOf("version")!==-1||e.startsWith("data:base64,"+$._MagicBase64Encoded)||e.startsWith("data:;base64,"+$._MagicBase64Encoded)||e.startsWith("data:application/octet-stream;base64,"+$._MagicBase64Encoded)||e.startsWith("data:model/gltf-binary;base64,"+$._MagicBase64Encoded)}directLoad(e,s){if(s.startsWith("base64,"+$._MagicBase64Encoded)||s.startsWith(";base64,"+$._MagicBase64Encoded)||s.startsWith("application/octet-stream;base64,"+$._MagicBase64Encoded)||s.startsWith("model/gltf-binary;base64,"+$._MagicBase64Encoded)){const t=Is(s);return this._validate(e,t),this._unpackBinaryAsync(new Oe({readAsync:(n,r)=>gs(t,n,r),byteLength:t.byteLength}))}return this._validate(e,s),Promise.resolve({json:this._parseJson(s)})}createPlugin(){return new $}get loaderState(){return this._state}whenCompleteAsync(){return new Promise((e,s)=>{this.onCompleteObservable.addOnce(()=>{e()}),this.onErrorObservable.addOnce(t=>{s(t)})})}_setState(e){this._state!==e&&(this._state=e,this.onLoaderStateChangedObservable.notifyObservers(this._state),this._log(z[this._state]))}_loadFile(e,s,t,n,r,o){const a=e._loadFile(s,t,l=>{this._onProgress(l,a)},!0,n,r,o);return a.onCompleteObservable.add(l=>{this._requests.splice(this._requests.indexOf(l),1)}),this._requests.push(a),a}_onProgress(e,s){if(!this._progressCallback)return;s._lengthComputable=e.lengthComputable,s._loaded=e.loaded,s._total=e.total;let t=!0,n=0,r=0;for(const o of this._requests){if(o._lengthComputable===void 0||o._loaded===void 0||o._total===void 0)return;t=t&&o._lengthComputable,n+=o._loaded,r+=o._total}this._progressCallback({lengthComputable:t,loaded:n,total:t?r:0})}_validate(e,s,t="",n=""){this.validate&&(this._startPerformanceCounter("Validate JSON"),Ls.ValidateAsync(s,t,n,r=>this.preprocessUrlAsync(t+r).then(o=>e._loadFileAsync(o,void 0,!0,!0))).then(r=>{this._endPerformanceCounter("Validate JSON"),this.onValidatedObservable.notifyObservers(r),this.onValidatedObservable.clear()},r=>{this._endPerformanceCounter("Validate JSON"),N.Warn(`Failed to validate: ${r.message}`),this.onValidatedObservable.clear()}))}_getLoader(e){const s=e.json.asset||{};this._log(`Asset version: ${s.version}`),s.minVersion&&this._log(`Asset minimum version: ${s.minVersion}`),s.generator&&this._log(`Asset generator: ${s.generator}`);const t=$._parseVersion(s.version);if(!t)throw new Error("Invalid version: "+s.version);if(s.minVersion!==void 0){const o=$._parseVersion(s.minVersion);if(!o)throw new Error("Invalid minimum version: "+s.minVersion);if($._compareVersion(o,{major:2,minor:0})>0)throw new Error("Incompatible minimum version: "+s.minVersion)}const r={1:$._CreateGLTF1Loader,2:$._CreateGLTF2Loader}[t.major];if(!r)throw new Error("Unsupported version: "+s.version);return r(this)}_parseJson(e){this._startPerformanceCounter("Parse JSON"),this._log(`JSON length: ${e.length}`);const s=JSON.parse(e);return this._endPerformanceCounter("Parse JSON"),s}_unpackBinaryAsync(e){return this._startPerformanceCounter("Unpack Binary"),e.loadAsync(20).then(()=>{const s={Magic:1179937895},t=e.readUint32();if(t!==s.Magic)throw new Ks("Unexpected magic: "+t,Ws.GLTFLoaderUnexpectedMagicError);const n=e.readUint32();this.loggingEnabled&&this._log(`Binary version: ${n}`);const r=e.readUint32();!this.useRangeRequests&&r!==e.buffer.byteLength&&U.Warn(`Length in header does not match actual data length: ${r} != ${e.buffer.byteLength}`);let o;switch(n){case 1:{o=this._unpackBinaryV1Async(e,r);break}case 2:{o=this._unpackBinaryV2Async(e,r);break}default:throw new Error("Unsupported version: "+n)}return this._endPerformanceCounter("Unpack Binary"),o})}_unpackBinaryV1Async(e,s){const t={JSON:0},n=e.readUint32(),r=e.readUint32();if(r!==t.JSON)throw new Error(`Unexpected content format: ${r}`);const o=s-e.byteOffset,a={json:this._parseJson(e.readString(n)),bin:null};if(o!==0){const l=e.byteOffset;a.bin={readAsync:(c,d)=>e.buffer.readAsync(l+c,d),byteLength:o}}return Promise.resolve(a)}_unpackBinaryV2Async(e,s){const t={JSON:1313821514,BIN:5130562},n=e.readUint32();if(e.readUint32()!==t.JSON)throw new Error("First chunk format is not JSON");return e.byteOffset+n===s?e.loadAsync(n).then(()=>({json:this._parseJson(e.readString(n)),bin:null})):e.loadAsync(n+8).then(()=>{const o={json:this._parseJson(e.readString(n)),bin:null},a=()=>{const l=e.readUint32();switch(e.readUint32()){case t.JSON:throw new Error("Unexpected JSON chunk");case t.BIN:{const d=e.byteOffset;o.bin={readAsync:(h,u)=>e.buffer.readAsync(d+h,u),byteLength:l},e.skipBytes(l);break}default:{e.skipBytes(l);break}}return e.byteOffset!==s?e.loadAsync(8).then(a):Promise.resolve(o)};return a()})}static _parseVersion(e){if(e==="1.0"||e==="1.0.1")return{major:1,minor:0};const s=(e+"").match(/^(\d+)\.(\d+)/);return s?{major:parseInt(s[1]),minor:parseInt(s[2])}:null}static _compareVersion(e,s){return e.major>s.major?1:e.major<s.major?-1:e.minor>s.minor?1:e.minor<s.minor?-1:0}_logOpen(e){this._log(e),this._logIndentLevel++}_logClose(){--this._logIndentLevel}_logEnabled(e){const s=$._logSpaces.substr(0,this._logIndentLevel*2);U.Log(`${s}${e}`)}_logDisabled(e){}_startPerformanceCounterEnabled(e){N.StartPerformanceCounter(e)}_startPerformanceCounterDisabled(e){}_endPerformanceCounterEnabled(e){N.EndPerformanceCounter(e)}_endPerformanceCounterDisabled(e){}}$.IncrementalLoading=!0;$.HomogeneousCoordinates=!1;$._MagicBase64Encoded="Z2xURg";$._logSpaces="                                ";ms&&ms.RegisterPlugin(new $);var ne;(function(i){i[i.BYTE=5120]="BYTE",i[i.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",i[i.SHORT=5122]="SHORT",i[i.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",i[i.FLOAT=5126]="FLOAT"})(ne||(ne={}));var Se;(function(i){i[i.FRAGMENT=35632]="FRAGMENT",i[i.VERTEX=35633]="VERTEX"})(Se||(Se={}));var Y;(function(i){i[i.BYTE=5120]="BYTE",i[i.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",i[i.SHORT=5122]="SHORT",i[i.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",i[i.INT=5124]="INT",i[i.UNSIGNED_INT=5125]="UNSIGNED_INT",i[i.FLOAT=5126]="FLOAT",i[i.FLOAT_VEC2=35664]="FLOAT_VEC2",i[i.FLOAT_VEC3=35665]="FLOAT_VEC3",i[i.FLOAT_VEC4=35666]="FLOAT_VEC4",i[i.INT_VEC2=35667]="INT_VEC2",i[i.INT_VEC3=35668]="INT_VEC3",i[i.INT_VEC4=35669]="INT_VEC4",i[i.BOOL=35670]="BOOL",i[i.BOOL_VEC2=35671]="BOOL_VEC2",i[i.BOOL_VEC3=35672]="BOOL_VEC3",i[i.BOOL_VEC4=35673]="BOOL_VEC4",i[i.FLOAT_MAT2=35674]="FLOAT_MAT2",i[i.FLOAT_MAT3=35675]="FLOAT_MAT3",i[i.FLOAT_MAT4=35676]="FLOAT_MAT4",i[i.SAMPLER_2D=35678]="SAMPLER_2D"})(Y||(Y={}));var _e;(function(i){i[i.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",i[i.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",i[i.REPEAT=10497]="REPEAT"})(_e||(_e={}));var Q;(function(i){i[i.NEAREST=9728]="NEAREST",i[i.LINEAR=9728]="LINEAR",i[i.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",i[i.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",i[i.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",i[i.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR"})(Q||(Q={}));var ys;(function(i){i[i.ALPHA=6406]="ALPHA",i[i.RGB=6407]="RGB",i[i.RGBA=6408]="RGBA",i[i.LUMINANCE=6409]="LUMINANCE",i[i.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA"})(ys||(ys={}));var Ie;(function(i){i[i.FRONT=1028]="FRONT",i[i.BACK=1029]="BACK",i[i.FRONT_AND_BACK=1032]="FRONT_AND_BACK"})(Ie||(Ie={}));var R;(function(i){i[i.ZERO=0]="ZERO",i[i.ONE=1]="ONE",i[i.SRC_COLOR=768]="SRC_COLOR",i[i.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",i[i.DST_COLOR=774]="DST_COLOR",i[i.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",i[i.SRC_ALPHA=770]="SRC_ALPHA",i[i.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",i[i.DST_ALPHA=772]="DST_ALPHA",i[i.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",i[i.CONSTANT_COLOR=32769]="CONSTANT_COLOR",i[i.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",i[i.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",i[i.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",i[i.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE"})(R||(R={}));class G{static SetMatrix(e,s,t,n,r){let o=null;if(t.semantic==="MODEL"?o=s.getWorldMatrix():t.semantic==="PROJECTION"?o=e.getProjectionMatrix():t.semantic==="VIEW"?o=e.getViewMatrix():t.semantic==="MODELVIEWINVERSETRANSPOSE"?o=q.Transpose(s.getWorldMatrix().multiply(e.getViewMatrix()).invert()):t.semantic==="MODELVIEW"?o=s.getWorldMatrix().multiply(e.getViewMatrix()):t.semantic==="MODELVIEWPROJECTION"?o=s.getWorldMatrix().multiply(e.getTransformMatrix()):t.semantic==="MODELINVERSE"?o=s.getWorldMatrix().invert():t.semantic==="VIEWINVERSE"?o=e.getViewMatrix().invert():t.semantic==="PROJECTIONINVERSE"?o=e.getProjectionMatrix().invert():t.semantic==="MODELVIEWINVERSE"?o=s.getWorldMatrix().multiply(e.getViewMatrix()).invert():t.semantic==="MODELVIEWPROJECTIONINVERSE"?o=s.getWorldMatrix().multiply(e.getTransformMatrix()).invert():t.semantic==="MODELINVERSETRANSPOSE"&&(o=q.Transpose(s.getWorldMatrix().invert())),o)switch(t.type){case Y.FLOAT_MAT2:r.setMatrix2x2(n,q.GetAsMatrix2x2(o));break;case Y.FLOAT_MAT3:r.setMatrix3x3(n,q.GetAsMatrix3x3(o));break;case Y.FLOAT_MAT4:r.setMatrix(n,o);break}}static SetUniform(e,s,t,n){switch(n){case Y.FLOAT:return e.setFloat(s,t),!0;case Y.FLOAT_VEC2:return e.setVector2(s,Ys.FromArray(t)),!0;case Y.FLOAT_VEC3:return e.setVector3(s,T.FromArray(t)),!0;case Y.FLOAT_VEC4:return e.setVector4(s,js.FromArray(t)),!0;default:return!1}}static GetWrapMode(e){switch(e){case _e.CLAMP_TO_EDGE:return v.CLAMP_ADDRESSMODE;case _e.MIRRORED_REPEAT:return v.MIRROR_ADDRESSMODE;case _e.REPEAT:return v.WRAP_ADDRESSMODE;default:return v.WRAP_ADDRESSMODE}}static GetByteStrideFromType(e){switch(e.type){case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 1}}static GetTextureFilterMode(e){switch(e){case Q.LINEAR:case Q.LINEAR_MIPMAP_NEAREST:case Q.LINEAR_MIPMAP_LINEAR:return v.TRILINEAR_SAMPLINGMODE;case Q.NEAREST:case Q.NEAREST_MIPMAP_NEAREST:return v.NEAREST_SAMPLINGMODE;default:return v.BILINEAR_SAMPLINGMODE}}static GetBufferFromBufferView(e,s,t,n,r){t=s.byteOffset+t;const o=e.loadedBufferViews[s.buffer];if(t+n>o.byteLength)throw new Error("Buffer access is out of range");const a=o.buffer;switch(t+=o.byteOffset,r){case ne.BYTE:return new Int8Array(a,t,n);case ne.UNSIGNED_BYTE:return new Uint8Array(a,t,n);case ne.SHORT:return new Int16Array(a,t,n);case ne.UNSIGNED_SHORT:return new Uint16Array(a,t,n);default:return new Float32Array(a,t,n)}}static GetBufferFromAccessor(e,s){const t=e.bufferViews[s.bufferView],n=s.count*G.GetByteStrideFromType(s);return G.GetBufferFromBufferView(e,t,s.byteOffset,n,s.componentType)}static DecodeBufferToText(e){let s="";const t=e.byteLength;for(let n=0;n<t;++n)s+=String.fromCharCode(e[n]);return s}static GetDefaultMaterial(e){if(!G._DefaultMaterial){ie.ShadersStore.GLTFDefaultMaterialVertexShader=["precision highp float;","","uniform mat4 worldView;","uniform mat4 projection;","","attribute vec3 position;","","void main(void)","{","    gl_Position = projection * worldView * vec4(position, 1.0);","}"].join(`
`),ie.ShadersStore.GLTFDefaultMaterialPixelShader=["precision highp float;","","uniform vec4 u_emission;","","void main(void)","{","    gl_FragColor = u_emission;","}"].join(`
`);const s={vertex:"GLTFDefaultMaterial",fragment:"GLTFDefaultMaterial"},t={attributes:["position"],uniforms:["worldView","projection","u_emission"],samplers:new Array,needAlphaBlending:!1};G._DefaultMaterial=new Ns("GLTFDefaultMaterial",e,s,t),G._DefaultMaterial.setColor4("u_emission",new qs(.5,.5,.5,1))}return G._DefaultMaterial}}G._DefaultMaterial=null;var re;(function(i){i[i.IDENTIFIER=1]="IDENTIFIER",i[i.UNKNOWN=2]="UNKNOWN",i[i.END_OF_INPUT=3]="END_OF_INPUT"})(re||(re={}));class bs{constructor(e){this._pos=0,this.currentToken=re.UNKNOWN,this.currentIdentifier="",this.currentString="",this.isLetterOrDigitPattern=/^[a-zA-Z0-9]+$/,this._toParse=e,this._maxPos=e.length}getNextToken(){if(this.isEnd())return re.END_OF_INPUT;if(this.currentString=this.read(),this.currentToken=re.UNKNOWN,this.currentString==="_"||this.isLetterOrDigitPattern.test(this.currentString))for(this.currentToken=re.IDENTIFIER,this.currentIdentifier=this.currentString;!this.isEnd()&&(this.isLetterOrDigitPattern.test(this.currentString=this.peek())||this.currentString==="_");)this.currentIdentifier+=this.currentString,this.forward();return this.currentToken}peek(){return this._toParse[this._pos]}read(){return this._toParse[this._pos++]}forward(){this._pos++}isEnd(){return this._pos>=this._maxPos}}const Ps=["MODEL","VIEW","PROJECTION","MODELVIEW","MODELVIEWPROJECTION","JOINTMATRIX"],$s=["world","view","projection","worldView","worldViewProjection","mBones"],pt=["translation","rotation","scale"],At=["position","rotationQuaternion","scaling"],gt=(i,e)=>{for(const s in i){const t=i[s];e.buffers[s]=t,e.buffersCount++}},yt=(i,e)=>{for(const s in i){const t=i[s];e.shaders[s]=t,e.shaderscount++}},K=(i,e,s)=>{for(const t in i){const n=i[t];s[e][t]=n}},bt=i=>{if(i)for(let e=0;e<i.length/2;e++)i[e*2+1]=1-i[e*2+1]},Os=i=>{if(i.semantic==="NORMAL")return"normal";if(i.semantic==="POSITION")return"position";if(i.semantic==="JOINT")return"matricesIndices";if(i.semantic==="WEIGHT")return"matricesWeights";if(i.semantic==="COLOR")return"color";if(i.semantic&&i.semantic.indexOf("TEXCOORD_")!==-1){const e=Number(i.semantic.split("_")[1]);return"uv"+(e===0?"":e+1)}return null},Ot=i=>{for(const e in i.animations){const s=i.animations[e];if(!s.channels||!s.samplers)continue;let t=null;for(let n=0;n<s.channels.length;n++){const r=s.channels[n],o=s.samplers[r.sampler];if(!o)continue;let a=null,l=null;s.parameters?(a=s.parameters[o.input],l=s.parameters[o.output]):(a=o.input,l=o.output);const c=G.GetBufferFromAccessor(i,i.accessors[a]),d=G.GetBufferFromAccessor(i,i.accessors[l]),h=r.target.id;let u=i.scene.getNodeById(h);if(u===null&&(u=i.scene.getNodeByName(h)),u===null){N.Warn("Creating animation named "+e+". But cannot find node named "+h+" to attach to");continue}const f=u instanceof Ae;let m=r.target.path;const g=pt.indexOf(m);g!==-1&&(m=At[g]);let E=y.ANIMATIONTYPE_MATRIX;f||(m==="rotationQuaternion"?(E=y.ANIMATIONTYPE_QUATERNION,u.rotationQuaternion=new J):E=y.ANIMATIONTYPE_VECTOR3);let A=null;const C=[];let I=0,M=!1;f&&t&&t.getKeys().length===c.length&&(A=t,M=!0),M||(i.scene._blockEntityCollection=!!i.assetContainer,A=new y(e,f?"_matrix":m,1,E,y.ANIMATIONLOOPMODE_CYCLE),i.scene._blockEntityCollection=!1);for(let O=0;O<c.length;O++){let w=null;if(m==="rotationQuaternion"?(w=J.FromArray([d[I],d[I+1],d[I+2],d[I+3]]),I+=4):(w=T.FromArray([d[I],d[I+1],d[I+2]]),I+=3),f){const b=u;let S=T.Zero(),B=new J,F=T.Zero(),k=b.getBaseMatrix();M&&t&&(k=t.getKeys()[O].value),k.decompose(F,B,S),m==="position"?S=w:m==="rotationQuaternion"?B=w:F=w,w=q.Compose(F,B,S)}M?t&&(t.getKeys()[O].value=w):C.push({frame:c[O],value:w})}!M&&A&&(A.setKeys(C),u.animations.push(A)),t=A,i.scene.stopAnimation(u),i.scene.beginAnimation(u,0,c[c.length-1],!0,1)}}},us=i=>{let e=null;if(i.translation||i.rotation||i.scale){const s=T.FromArray(i.scale||[1,1,1]),t=J.FromArray(i.rotation||[0,0,0,1]),n=T.FromArray(i.translation||[0,0,0]);e=q.Compose(s,t,n)}else e=q.FromArray(i.matrix);return e},Rs=(i,e,s,t)=>{for(let r=0;r<t.bones.length;r++)if(t.bones[r].name===s)return t.bones[r];const n=i.nodes;for(const r in n){const o=n[r];if(!o.jointName)continue;const a=o.children;for(let l=0;l<a.length;l++){const c=i.nodes[a[l]];if(c.jointName&&c.jointName===s){const d=us(o),h=new Ae(o.name||"",t,Rs(i,e,o.jointName,t),d);return h.id=r,h}}}return null},Et=(i,e)=>{for(let s=0;s<i.length;s++){const t=i[s];for(let n=0;n<t.node.children.length;n++)if(t.node.children[n]===e)return t.bone}return null},Ee=(i,e)=>{const s=i.nodes;let t=s[e];if(t)return{node:t,id:e};for(const n in s)if(t=s[n],t.jointName===e)return{node:t,id:n};return null},Tt=(i,e)=>{for(let s=0;s<i.jointNames.length;s++)if(i.jointNames[s]===e)return!0;return!1},xt=(i,e,s,t)=>{for(const n in i.nodes){const r=i.nodes[n],o=n;if(!r.jointName||Tt(s,r.jointName))continue;const a=us(r),l=new Ae(r.name||"",e,null,a);l.id=o,t.push({bone:l,node:r,id:o})}for(let n=0;n<t.length;n++){const r=t[n],o=r.node.children;for(let a=0;a<o.length;a++){let l=null;for(let c=0;c<t.length;c++)if(t[c].id===o[a]){l=t[c];break}l&&(l.bone._parent=r.bone,r.bone.children.push(l.bone))}}},Ct=(i,e,s,t)=>{if(t||(t=new rs(e.name||"","",i.scene)),!e.babylonSkeleton)return t;const n=[],r=[];xt(i,t,e,n),t.bones=[];for(let a=0;a<e.jointNames.length;a++){const l=Ee(i,e.jointNames[a]);if(!l)continue;const c=l.node;if(!c){N.Warn("Joint named "+e.jointNames[a]+" does not exist");continue}const d=l.id,h=i.scene.getBoneById(d);if(h){t.bones.push(h);continue}let u=!1,f=null;for(let E=0;E<a;E++){const A=Ee(i,e.jointNames[E]);if(!A)continue;const C=A.node;if(!C){N.Warn("Joint named "+e.jointNames[E]+" does not exist when looking for parent");continue}const I=C.children;if(I){u=!1;for(let M=0;M<I.length;M++)if(I[M]===d){f=Rs(i,e,e.jointNames[E],t),u=!0;break}if(u)break}}const m=us(c);!f&&n.length>0&&(f=Et(n,d),f&&r.indexOf(f)===-1&&r.push(f));const g=new Ae(c.jointName||"",t,f,m);g.id=d}const o=t.bones;t.bones=[];for(let a=0;a<e.jointNames.length;a++){const l=Ee(i,e.jointNames[a]);if(l){for(let c=0;c<o.length;c++)if(o[c].id===l.id){t.bones.push(o[c]);break}}}t.prepare();for(let a=0;a<r.length;a++)t.bones.push(r[a]);return t},Es=(i,e,s,t,n)=>{if(n||(i.scene._blockEntityCollection=!!i.assetContainer,n=new ce(e.name||"",i.scene),n._parentContainer=i.assetContainer,i.scene._blockEntityCollection=!1,n.id=t),!e.babylonNode)return n;const r=[];let o=null;const a=new Array,l=new Array,c=new Array,d=new Array;for(let f=0;f<s.length;f++){const m=s[f],g=i.meshes[m];if(g)for(let E=0;E<g.primitives.length;E++){const A=new zs,C=g.primitives[E];C.mode;const I=C.attributes;let M=null,O=null;for(const b in I)if(M=i.accessors[I[b]],O=G.GetBufferFromAccessor(i,M),b==="NORMAL")A.normals=new Float32Array(O.length),A.normals.set(O);else if(b==="POSITION"){if($.HomogeneousCoordinates){A.positions=new Float32Array(O.length-O.length/4);for(let S=0;S<O.length;S+=4)A.positions[S]=O[S],A.positions[S+1]=O[S+1],A.positions[S+2]=O[S+2]}else A.positions=new Float32Array(O.length),A.positions.set(O);l.push(A.positions.length)}else if(b.indexOf("TEXCOORD_")!==-1){const S=Number(b.split("_")[1]),B=x.UVKind+(S===0?"":S+1),F=new Float32Array(O.length);F.set(O),bt(F),A.set(F,B)}else b==="JOINT"?(A.matricesIndices=new Float32Array(O.length),A.matricesIndices.set(O)):b==="WEIGHT"?(A.matricesWeights=new Float32Array(O.length),A.matricesWeights.set(O)):b==="COLOR"&&(A.colors=new Float32Array(O.length),A.colors.set(O));if(M=i.accessors[C.indices],M)O=G.GetBufferFromAccessor(i,M),A.indices=new Int32Array(O.length),A.indices.set(O),d.push(A.indices.length);else{const b=[];for(let S=0;S<A.positions.length/3;S++)b.push(S);A.indices=new Int32Array(b),d.push(A.indices.length)}o?o.merge(A):o=A;const w=i.scene.getMaterialById(C.material);r.push(w===null?G.GetDefaultMaterial(i.scene):w),a.push(a.length===0?0:a[a.length-1]+l[l.length-2]),c.push(c.length===0?0:c[c.length-1]+d[d.length-2])}}let h;i.scene._blockEntityCollection=!!i.assetContainer,r.length>1?(h=new Xs("multimat"+t,i.scene),h.subMaterials=r):h=new os("multimat"+t,i.scene),r.length===1&&(h=r[0]),h._parentContainer=i.assetContainer,n.material||(n.material=h),new cs(t,i.scene,o,!1,n),n.computeWorldMatrix(!0),i.scene._blockEntityCollection=!1,n.subMeshes=[];let u=0;for(let f=0;f<s.length;f++){const m=s[f],g=i.meshes[m];if(g)for(let E=0;E<g.primitives.length;E++)g.primitives[E].mode,Zs.AddToMesh(u,a[u],l[u],c[u],d[u],n,n,!0),u++}return n},Ne=(i,e,s,t)=>{i.position&&(i.position=e),(i.rotationQuaternion||i.rotation)&&(i.rotationQuaternion=s),i.scaling&&(i.scaling=t)},wt=(i,e)=>{if(e.matrix){const s=new T(0,0,0),t=new J,n=new T(0,0,0);q.FromArray(e.matrix).decompose(n,t,s),Ne(i,s,t,n)}else e.translation&&e.rotation&&e.scale&&Ne(i,T.FromArray(e.translation),J.FromArray(e.rotation),T.FromArray(e.scale));i.computeWorldMatrix(!0)},St=(i,e,s)=>{let t=null;if(i.importOnlyMeshes&&(e.skin||e.meshes)&&i.importMeshesNames&&i.importMeshesNames.length>0&&i.importMeshesNames.indexOf(e.name||"")===-1)return null;if(e.skin){if(e.meshes){const n=i.skins[e.skin],r=Es(i,e,e.meshes,s,e.babylonNode);r.skeleton=i.scene.getLastSkeletonById(e.skin),r.skeleton===null&&(r.skeleton=Ct(i,n,r,n.babylonSkeleton),n.babylonSkeleton||(n.babylonSkeleton=r.skeleton)),t=r}}else if(e.meshes)t=Es(i,e,e.mesh?[e.mesh]:e.meshes,s,e.babylonNode);else if(e.light&&!e.babylonNode&&!i.importOnlyMeshes){const n=i.lights[e.light];if(n){if(n.type==="ambient"){const r=n[n.type],o=new Ms(e.light,T.Zero(),i.scene);o.name=e.name||"",r.color&&(o.diffuse=L.FromArray(r.color)),t=o}else if(n.type==="directional"){const r=n[n.type],o=new is(e.light,T.Zero(),i.scene);o.name=e.name||"",r.color&&(o.diffuse=L.FromArray(r.color)),t=o}else if(n.type==="point"){const r=n[n.type],o=new as(e.light,T.Zero(),i.scene);o.name=e.name||"",r.color&&(o.diffuse=L.FromArray(r.color)),t=o}else if(n.type==="spot"){const r=n[n.type],o=new ls(e.light,T.Zero(),T.Zero(),0,0,i.scene);o.name=e.name||"",r.color&&(o.diffuse=L.FromArray(r.color)),r.fallOfAngle&&(o.angle=r.fallOfAngle),r.fallOffExponent&&(o.exponent=r.fallOffExponent),t=o}}}else if(e.camera&&!e.babylonNode&&!i.importOnlyMeshes){const n=i.cameras[e.camera];if(n){if(i.scene._blockEntityCollection=!!i.assetContainer,n.type==="orthographic"){const r=new Ce(e.camera,T.Zero(),i.scene,!1);r.name=e.name||"",r.mode=vs.ORTHOGRAPHIC_CAMERA,r.attachControl(),t=r,r._parentContainer=i.assetContainer}else if(n.type==="perspective"){const r=n[n.type],o=new Ce(e.camera,T.Zero(),i.scene,!1);o.name=e.name||"",o.attachControl(),r.aspectRatio||(r.aspectRatio=i.scene.getEngine().getRenderWidth()/i.scene.getEngine().getRenderHeight()),r.znear&&r.zfar&&(o.maxZ=r.zfar,o.minZ=r.znear),t=o,o._parentContainer=i.assetContainer}i.scene._blockEntityCollection=!1}}if(!e.jointName){if(e.babylonNode)return e.babylonNode;if(t===null){i.scene._blockEntityCollection=!!i.assetContainer;const n=new ce(e.name||"",i.scene);n._parentContainer=i.assetContainer,i.scene._blockEntityCollection=!1,e.babylonNode=n,t=n}}if(t!==null){if(e.matrix&&t instanceof ce)wt(t,e);else{const n=e.translation||[0,0,0],r=e.rotation||[0,0,0,1],o=e.scale||[1,1,1];Ne(t,T.FromArray(n),J.FromArray(r),T.FromArray(o))}t.updateCache(!0),e.babylonNode=t}return t},pe=(i,e,s,t=!1)=>{const n=i.nodes[e];let r=null;if(i.importOnlyMeshes&&!t&&i.importMeshesNames?i.importMeshesNames.indexOf(n.name||"")!==-1||i.importMeshesNames.length===0?t=!0:t=!1:t=!0,!n.jointName&&t&&(r=St(i,n,e),r!==null&&(r.id=e,r.parent=s)),n.children)for(let o=0;o<n.children.length;o++)pe(i,n.children[o],r,t)},Ts=i=>{let e=i.currentScene;if(e)for(let s=0;s<e.nodes.length;s++)pe(i,e.nodes[s],null);else for(const s in i.scenes){e=i.scenes[s];for(let t=0;t<e.nodes.length;t++)pe(i,e.nodes[t],null)}Ot(i);for(let s=0;s<i.scene.skeletons.length;s++){const t=i.scene.skeletons[s];i.scene.beginAnimation(t,0,Number.MAX_VALUE,!0,1)}},It=(i,e,s,t,n,r,o)=>{const a=r.values||n.parameters;for(const l in s){const c=s[l],d=c.type;if(d===Y.FLOAT_MAT2||d===Y.FLOAT_MAT3||d===Y.FLOAT_MAT4){if(c.semantic&&!c.source&&!c.node)G.SetMatrix(e.scene,i,c,l,t.getEffect());else if(c.semantic&&(c.source||c.node)){let h=e.scene.getNodeByName(c.source||c.node||"");if(h===null&&(h=e.scene.getNodeById(c.source||c.node||"")),h===null)continue;G.SetMatrix(e.scene,h,c,l,t.getEffect())}}else{const h=a[n.uniforms[l]];if(!h)continue;if(d===Y.SAMPLER_2D){const u=e.textures[r.values?h:c.value].babylonTexture;if(u==null)continue;t.getEffect().setTexture(l,u)}else G.SetUniform(t.getEffect(),l,h,d)}}o(t)},Nt=(i,e,s,t,n)=>{const r=t.values||s.parameters,o=s.uniforms;for(const a in n){const l=n[a],c=l.type;let d=r[o[a]];if(d===void 0&&(d=l.value),!d)continue;const h=u=>f=>{l.value&&u&&(e.setTexture(u,f),delete n[u])};c===Y.SAMPLER_2D?H.LoadTextureAsync(i,t.values?d:l.value,h(a),()=>h(null)):l.value&&G.SetUniform(e,a,t.values?d:l.value,c)&&delete n[a]}},Mt=(i,e,s)=>(t,n)=>{e.dispose(!0),s("Cannot compile program named "+i.name+". Error: "+n+". Default material will be applied")},vt=(i,e,s,t,n,r)=>o=>{Nt(i,e,s,t,n),e.onBind=a=>{It(a,i,n,e,s,t,r)}},xs=(i,e,s)=>{for(const t in e.uniforms){const n=e.uniforms[t],r=e.parameters[n];if(i.currentIdentifier===t&&r.semantic&&!r.source&&!r.node){const o=Ps.indexOf(r.semantic);if(o!==-1)return delete s[t],$s[o]}}return i.currentIdentifier},Cs=i=>{for(const e in i.materials)H.LoadMaterialAsync(i,e,()=>{},()=>{})};class se{static CreateRuntime(e,s,t){const n={extensions:{},accessors:{},buffers:{},bufferViews:{},meshes:{},lights:{},cameras:{},nodes:{},images:{},textures:{},shaders:{},programs:{},samplers:{},techniques:{},materials:{},animations:{},skins:{},extensionsUsed:[],scenes:{},buffersCount:0,shaderscount:0,scene:s,rootUrl:t,loadedBufferCount:0,loadedBufferViews:{},loadedShaderCount:0,importOnlyMeshes:!1,dummyNodes:[],assetContainer:null};return e.extensions&&K(e.extensions,"extensions",n),e.extensionsUsed&&K(e.extensionsUsed,"extensionsUsed",n),e.buffers&&gt(e.buffers,n),e.bufferViews&&K(e.bufferViews,"bufferViews",n),e.accessors&&K(e.accessors,"accessors",n),e.meshes&&K(e.meshes,"meshes",n),e.lights&&K(e.lights,"lights",n),e.cameras&&K(e.cameras,"cameras",n),e.nodes&&K(e.nodes,"nodes",n),e.images&&K(e.images,"images",n),e.textures&&K(e.textures,"textures",n),e.shaders&&yt(e.shaders,n),e.programs&&K(e.programs,"programs",n),e.samplers&&K(e.samplers,"samplers",n),e.techniques&&K(e.techniques,"techniques",n),e.materials&&K(e.materials,"materials",n),e.animations&&K(e.animations,"animations",n),e.skins&&K(e.skins,"skins",n),e.scenes&&(n.scenes=e.scenes),e.scene&&e.scenes&&(n.currentScene=e.scenes[e.scene]),n}static LoadBufferAsync(e,s,t,n,r){const o=e.buffers[s];N.IsBase64(o.uri)?setTimeout(()=>t(new Uint8Array(N.DecodeBase64(o.uri)))):N.LoadFile(e.rootUrl+o.uri,a=>t(new Uint8Array(a)),r,void 0,!0,a=>{a&&n(a.status+" "+a.statusText)})}static LoadTextureBufferAsync(e,s,t,n){const r=e.textures[s];if(!r||!r.source){n("");return}if(r.babylonTexture){t(null);return}const o=e.images[r.source];N.IsBase64(o.uri)?setTimeout(()=>t(new Uint8Array(N.DecodeBase64(o.uri)))):N.LoadFile(e.rootUrl+o.uri,a=>t(new Uint8Array(a)),void 0,void 0,!0,a=>{a&&n(a.status+" "+a.statusText)})}static CreateTextureAsync(e,s,t,n){const r=e.textures[s];if(r.babylonTexture){n(r.babylonTexture);return}const o=e.samplers[r.sampler],a=o.minFilter===Q.NEAREST_MIPMAP_NEAREST||o.minFilter===Q.NEAREST_MIPMAP_LINEAR||o.minFilter===Q.LINEAR_MIPMAP_NEAREST||o.minFilter===Q.LINEAR_MIPMAP_LINEAR,l=v.BILINEAR_SAMPLINGMODE,c=t==null?new Blob:new Blob([t]),d=URL.createObjectURL(c),h=()=>URL.revokeObjectURL(d),u=new v(d,e.scene,!a,!0,l,h,h);o.wrapS!==void 0&&(u.wrapU=G.GetWrapMode(o.wrapS)),o.wrapT!==void 0&&(u.wrapV=G.GetWrapMode(o.wrapT)),u.name=s,r.babylonTexture=u,n(u)}static LoadShaderStringAsync(e,s,t,n){const r=e.shaders[s];if(N.IsBase64(r.uri)){const o=atob(r.uri.split(",")[1]);t&&t(o)}else N.LoadFile(e.rootUrl+r.uri,t,void 0,void 0,!1,o=>{o&&n&&n(o.status+" "+o.statusText)})}static LoadMaterialAsync(e,s,t,n){const r=e.materials[s];if(!r.technique){n&&n("No technique found.");return}const o=e.techniques[r.technique];if(!o){e.scene._blockEntityCollection=!!e.assetContainer;const w=new os(s,e.scene);w._parentContainer=e.assetContainer,e.scene._blockEntityCollection=!1,w.diffuseColor=new L(.5,.5,.5),w.sideOrientation=Z.CounterClockWiseSideOrientation,t(w);return}const a=e.programs[o.program],l=o.states,c=ie.ShadersStore[a.vertexShader+"VertexShader"],d=ie.ShadersStore[a.fragmentShader+"PixelShader"];let h="",u="";const f=new bs(c),m=new bs(d),g={},E=[],A=[],C=[];for(const w in o.uniforms){const b=o.uniforms[w],S=o.parameters[b];if(g[w]=S,S.semantic&&!S.node&&!S.source){const B=Ps.indexOf(S.semantic);B!==-1?(E.push($s[B]),delete g[w]):E.push(w)}else S.type===Y.SAMPLER_2D?C.push(w):E.push(w)}for(const w in o.attributes){const b=o.attributes[w],S=o.parameters[b];if(S.semantic){const B=Os(S);B&&A.push(B)}}for(;!f.isEnd()&&f.getNextToken();){if(f.currentToken!==re.IDENTIFIER){h+=f.currentString;continue}let b=!1;for(const S in o.attributes){const B=o.attributes[S],F=o.parameters[B];if(f.currentIdentifier===S&&F.semantic){h+=Os(F),b=!0;break}}b||(h+=xs(f,o,g))}for(;!m.isEnd()&&m.getNextToken();){if(m.currentToken!==re.IDENTIFIER){u+=m.currentString;continue}u+=xs(m,o,g)}const I={vertex:a.vertexShader+s,fragment:a.fragmentShader+s},M={attributes:A,uniforms:E,samplers:C,needAlphaBlending:l&&l.enable&&l.enable.indexOf(3042)!==-1};ie.ShadersStore[a.vertexShader+s+"VertexShader"]=h,ie.ShadersStore[a.fragmentShader+s+"PixelShader"]=u;const O=new Ns(s,e.scene,I,M);if(O.onError=Mt(a,O,n),O.onCompiled=vt(e,O,o,r,g,t),O.sideOrientation=Z.CounterClockWiseSideOrientation,l&&l.functions){const w=l.functions;w.cullFace&&w.cullFace[0]!==Ie.BACK&&(O.backFaceCulling=!1);const b=w.blendFuncSeparate;b&&(b[0]===R.SRC_ALPHA&&b[1]===R.ONE_MINUS_SRC_ALPHA&&b[2]===R.ONE&&b[3]===R.ONE?O.alphaMode=oe.ALPHA_COMBINE:b[0]===R.ONE&&b[1]===R.ONE&&b[2]===R.ZERO&&b[3]===R.ONE?O.alphaMode=oe.ALPHA_ONEONE:b[0]===R.SRC_ALPHA&&b[1]===R.ONE&&b[2]===R.ZERO&&b[3]===R.ONE?O.alphaMode=oe.ALPHA_ADD:b[0]===R.ZERO&&b[1]===R.ONE_MINUS_SRC_COLOR&&b[2]===R.ONE&&b[3]===R.ONE?O.alphaMode=oe.ALPHA_SUBTRACT:b[0]===R.DST_COLOR&&b[1]===R.ZERO&&b[2]===R.ONE&&b[3]===R.ONE?O.alphaMode=oe.ALPHA_MULTIPLY:b[0]===R.SRC_ALPHA&&b[1]===R.ONE_MINUS_SRC_COLOR&&b[2]===R.ONE&&b[3]===R.ONE&&(O.alphaMode=oe.ALPHA_MAXIMIZED))}}}let de=class Me{static RegisterExtension(e){if(Me.Extensions[e.name]){N.Error('Tool with the same name "'+e.name+'" already exists');return}Me.Extensions[e.name]=e}dispose(){}_importMeshAsync(e,s,t,n,r,o,a,l){return s.useRightHandedSystem=!0,H.LoadRuntimeAsync(s,t,n,c=>{c.assetContainer=r,c.importOnlyMeshes=!0,e===""?c.importMeshesNames=[]:typeof e=="string"?c.importMeshesNames=[e]:e&&!(e instanceof Array)?c.importMeshesNames=[e]:(c.importMeshesNames=[],N.Warn("Argument meshesNames must be of type string or string[]")),this._createNodes(c);const d=new Array,h=new Array;for(const u in c.nodes){const f=c.nodes[u];f.babylonNode instanceof Js&&d.push(f.babylonNode)}for(const u in c.skins){const f=c.skins[u];f.babylonSkeleton instanceof rs&&h.push(f.babylonSkeleton)}this._loadBuffersAsync(c,()=>{this._loadShadersAsync(c,()=>{Cs(c),Ts(c),!$.IncrementalLoading&&o&&o(d,h)})}),$.IncrementalLoading&&o&&o(d,h)},l),!0}importMeshAsync(e,s,t,n,r,o){return new Promise((a,l)=>{this._importMeshAsync(e,s,n,r,t,(c,d)=>{a({meshes:c,particleSystems:[],skeletons:d,animationGroups:[],lights:[],transformNodes:[],geometries:[]})},o,c=>{l(new Error(c))})})}_loadAsync(e,s,t,n,r,o){e.useRightHandedSystem=!0,H.LoadRuntimeAsync(e,s,t,a=>{H.LoadRuntimeExtensionsAsync(a,()=>{this._createNodes(a),this._loadBuffersAsync(a,()=>{this._loadShadersAsync(a,()=>{Cs(a),Ts(a),$.IncrementalLoading||n()})}),$.IncrementalLoading&&n()},o)},o)}loadAsync(e,s,t,n){return new Promise((r,o)=>{this._loadAsync(e,s,t,()=>{r()},n,a=>{o(new Error(a))})})}_loadShadersAsync(e,s){let t=!1;const n=(r,o)=>{H.LoadShaderStringAsync(e,r,a=>{a instanceof ArrayBuffer||(e.loadedShaderCount++,a&&(ie.ShadersStore[r+(o.type===Se.VERTEX?"VertexShader":"PixelShader")]=a),e.loadedShaderCount===e.shaderscount&&s())},()=>{N.Error("Error when loading shader program named "+r+" located at "+o.uri)})};for(const r in e.shaders){t=!0;const o=e.shaders[r];o?n.bind(this,r,o)():N.Error("No shader named: "+r)}t||s()}_loadBuffersAsync(e,s){let t=!1;const n=(r,o)=>{H.LoadBufferAsync(e,r,a=>{e.loadedBufferCount++,a&&(a.byteLength!=e.buffers[r].byteLength&&N.Error("Buffer named "+r+" is length "+a.byteLength+". Expected: "+o.byteLength),e.loadedBufferViews[r]=a),e.loadedBufferCount===e.buffersCount&&s()},()=>{N.Error("Error when loading buffer named "+r+" located at "+o.uri)})};for(const r in e.buffers){t=!0;const o=e.buffers[r];o?n.bind(this,r,o)():N.Error("No buffer named: "+r)}t||s()}_createNodes(e){let s=e.currentScene;if(s)for(let t=0;t<s.nodes.length;t++)pe(e,s.nodes[t],null);else for(const t in e.scenes){s=e.scenes[t];for(let n=0;n<s.nodes.length;n++)pe(e,s.nodes[n],null)}}};de.Extensions={};class H{constructor(e){this._name=e}get name(){return this._name}loadRuntimeAsync(e,s,t,n,r){return!1}loadRuntimeExtensionsAsync(e,s,t){return!1}loadBufferAsync(e,s,t,n,r){return!1}loadTextureBufferAsync(e,s,t,n){return!1}createTextureAsync(e,s,t,n,r){return!1}loadShaderStringAsync(e,s,t,n){return!1}loadMaterialAsync(e,s,t,n){return!1}static LoadRuntimeAsync(e,s,t,n,r){H._ApplyExtensions(o=>o.loadRuntimeAsync(e,s,t,n,r),()=>{setTimeout(()=>{n&&n(se.CreateRuntime(s.json,e,t))})})}static LoadRuntimeExtensionsAsync(e,s,t){H._ApplyExtensions(n=>n.loadRuntimeExtensionsAsync(e,s,t),()=>{setTimeout(()=>{s()})})}static LoadBufferAsync(e,s,t,n,r){H._ApplyExtensions(o=>o.loadBufferAsync(e,s,t,n,r),()=>{se.LoadBufferAsync(e,s,t,n,r)})}static LoadTextureAsync(e,s,t,n){H._LoadTextureBufferAsync(e,s,r=>{r&&H._CreateTextureAsync(e,s,r,t,n)},n)}static LoadShaderStringAsync(e,s,t,n){H._ApplyExtensions(r=>r.loadShaderStringAsync(e,s,t,n),()=>{se.LoadShaderStringAsync(e,s,t,n)})}static LoadMaterialAsync(e,s,t,n){H._ApplyExtensions(r=>r.loadMaterialAsync(e,s,t,n),()=>{se.LoadMaterialAsync(e,s,t,n)})}static _LoadTextureBufferAsync(e,s,t,n){H._ApplyExtensions(r=>r.loadTextureBufferAsync(e,s,t,n),()=>{se.LoadTextureBufferAsync(e,s,t,n)})}static _CreateTextureAsync(e,s,t,n,r){H._ApplyExtensions(o=>o.createTextureAsync(e,s,t,n,r),()=>{se.CreateTextureAsync(e,s,t,n)})}static _ApplyExtensions(e,s){for(const t in de.Extensions){const n=de.Extensions[t];if(e(n))return}s()}}$._CreateGLTF1Loader=()=>new de;const Lt="binary_glTF";class Pt extends H{constructor(){super("KHR_binary_glTF")}loadRuntimeAsync(e,s,t,n){const r=s.json.extensionsUsed;return!r||r.indexOf(this.name)===-1||!s.bin?!1:(this._bin=s.bin,n(se.CreateRuntime(s.json,e,t)),!0)}loadBufferAsync(e,s,t,n){return e.extensionsUsed.indexOf(this.name)===-1||s!==Lt?!1:(this._bin.readAsync(0,this._bin.byteLength).then(t,r=>n(r.message)),!0)}loadTextureBufferAsync(e,s,t){const n=e.textures[s],r=e.images[n.source];if(!r.extensions||!(this.name in r.extensions))return!1;const o=r.extensions[this.name],a=e.bufferViews[o.bufferView],l=G.GetBufferFromBufferView(e,a,0,a.byteLength,ne.UNSIGNED_BYTE);return t(l),!0}loadShaderStringAsync(e,s,t){const n=e.shaders[s];if(!n.extensions||!(this.name in n.extensions))return!1;const r=n.extensions[this.name],o=e.bufferViews[r.bufferView],a=G.GetBufferFromBufferView(e,o,0,o.byteLength,ne.UNSIGNED_BYTE);return setTimeout(()=>{const l=G.DecodeBufferToText(a);t(l)}),!0}}de.RegisterExtension(new Pt);class $t extends H{constructor(){super("KHR_materials_common")}loadRuntimeExtensionsAsync(e){if(!e.extensions)return!1;const s=e.extensions[this.name];if(!s)return!1;const t=s.lights;if(t)for(const n in t){const r=t[n];switch(r.type){case"ambient":{const o=new Ms(r.name,new T(0,1,0),e.scene),a=r.ambient;a&&(o.diffuse=L.FromArray(a.color||[1,1,1]));break}case"point":{const o=new as(r.name,new T(10,10,10),e.scene),a=r.point;a&&(o.diffuse=L.FromArray(a.color||[1,1,1]));break}case"directional":{const o=new is(r.name,new T(0,-1,0),e.scene),a=r.directional;a&&(o.diffuse=L.FromArray(a.color||[1,1,1]));break}case"spot":{const o=r.spot;if(o){const a=new ls(r.name,new T(0,10,0),new T(0,-1,0),o.fallOffAngle||Math.PI,o.fallOffExponent||0,e.scene);a.diffuse=L.FromArray(o.color||[1,1,1])}break}default:N.Warn('GLTF Material Common extension: light type "'+r.type+"” not supported");break}}return!1}loadMaterialAsync(e,s,t,n){const r=e.materials[s];if(!r||!r.extensions)return!1;const o=r.extensions[this.name];if(!o)return!1;const a=new os(s,e.scene);return a.sideOrientation=Z.CounterClockWiseSideOrientation,o.technique==="CONSTANT"&&(a.disableLighting=!0),a.backFaceCulling=o.doubleSided===void 0?!1:!o.doubleSided,a.alpha=o.values.transparency===void 0?1:o.values.transparency,a.specularPower=o.values.shininess===void 0?0:o.values.shininess,typeof o.values.ambient=="string"?this._loadTexture(e,o.values.ambient,a,"ambientTexture",n):a.ambientColor=L.FromArray(o.values.ambient||[0,0,0]),typeof o.values.diffuse=="string"?this._loadTexture(e,o.values.diffuse,a,"diffuseTexture",n):a.diffuseColor=L.FromArray(o.values.diffuse||[0,0,0]),typeof o.values.emission=="string"?this._loadTexture(e,o.values.emission,a,"emissiveTexture",n):a.emissiveColor=L.FromArray(o.values.emission||[0,0,0]),typeof o.values.specular=="string"?this._loadTexture(e,o.values.specular,a,"specularTexture",n):a.specularColor=L.FromArray(o.values.specular||[0,0,0]),!0}_loadTexture(e,s,t,n,r){se.LoadTextureBufferAsync(e,s,o=>{se.CreateTextureAsync(e,s,o,a=>t[n]=a)},r)}}de.RegisterExtension(new $t);function ws(i,e,s,t){return T.FromArray(e,s).scaleInPlace(t)}function Rt(i,e,s,t){return J.FromArray(e,s).scaleInPlace(t)}function Dt(i,e,s,t){const n=new Array(i._numMorphTargets);for(let r=0;r<n.length;r++)n[r]=e[s++]*t;return n}class ge{constructor(e,s,t,n){this.type=e,this.name=s,this.getValue=t,this.getStride=n}_buildAnimation(e,s,t){const n=new y(e,this.name,s,this.type);return n.setKeys(t),n}}class Te extends ge{buildAnimations(e,s,t,n,r){r(e._babylonTransformNode,this._buildAnimation(s,t,n))}}class Bt extends ge{buildAnimations(e,s,t,n,r){if(e._numMorphTargets)for(let o=0;o<e._numMorphTargets;o++){const a=new y(`${s}_${o}`,this.name,t,this.type);if(a.setKeys(n.map(l=>({frame:l.frame,inTangent:l.inTangent?l.inTangent[o]:void 0,value:l.value[o],outTangent:l.outTangent?l.outTangent[o]:void 0,interpolation:l.interpolation}))),e._primitiveBabylonMeshes){for(const l of e._primitiveBabylonMeshes)if(l.morphTargetManager){const c=l.morphTargetManager.getTarget(o),d=a.clone();c.animations.push(d),r(c,d)}}}}}const fe={translation:[new Te(y.ANIMATIONTYPE_VECTOR3,"position",ws,()=>3)],rotation:[new Te(y.ANIMATIONTYPE_QUATERNION,"rotationQuaternion",Rt,()=>4)],scale:[new Te(y.ANIMATIONTYPE_VECTOR3,"scaling",ws,()=>3)],weights:[new Bt(y.ANIMATIONTYPE_FLOAT,"influence",Dt,i=>i._numMorphTargets)]};function Ds(...i){const e=s=>s&&typeof s=="object";return i.reduce((s,t)=>(Object.keys(t).forEach(n=>{const r=s[n],o=t[n];Array.isArray(r)&&Array.isArray(o)?s[n]=r.concat(...o):e(r)&&e(o)?s[n]=Ds(r,o):s[n]=o}),s),{})}class p{static Get(e,s,t){if(!s||t==null||!s[t])throw new Error(`${e}: Failed to find index (${t})`);return s[t]}static Assign(e){if(e)for(let s=0;s<e.length;s++)e[s].index=s}}class _{static RegisterExtension(e,s){_.UnregisterExtension(e)&&U.Warn(`Extension with the name '${e}' already exists`),_._RegisteredExtensions[e]={factory:s}}static UnregisterExtension(e){return _._RegisteredExtensions[e]?(delete _._RegisteredExtensions[e],!0):!1}get gltf(){if(!this._gltf)throw new Error("glTF JSON is not available");return this._gltf}get bin(){return this._bin}get parent(){return this._parent}get babylonScene(){if(!this._babylonScene)throw new Error("Scene is not available");return this._babylonScene}get rootBabylonMesh(){return this._rootBabylonMesh}constructor(e){this._completePromises=new Array,this._assetContainer=null,this._babylonLights=[],this._disableInstancedMesh=0,this._extensions=new Array,this._disposed=!1,this._rootUrl=null,this._fileName=null,this._uniqueRootUrl=null,this._bin=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions=new Array,this._parent=e}dispose(){this._disposed||(this._disposed=!0,this._completePromises.length=0,this._extensions.forEach(e=>e.dispose&&e.dispose()),this._extensions.length=0,this._gltf=null,this._bin=null,this._babylonScene=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions.length=0,this._parent.dispose())}importMeshAsync(e,s,t,n,r,o,a=""){return Promise.resolve().then(()=>{this._babylonScene=s,this._assetContainer=t,this._loadData(n);let l=null;if(e){const c={};if(this._gltf.nodes)for(const h of this._gltf.nodes)h.name&&(c[h.name]=h.index);l=(e instanceof Array?e:[e]).map(h=>{const u=c[h];if(u===void 0)throw new Error(`Failed to find node '${h}'`);return u})}return this._loadAsync(r,a,l,()=>({meshes:this._getMeshes(),particleSystems:[],skeletons:this._getSkeletons(),animationGroups:this._getAnimationGroups(),lights:this._babylonLights,transformNodes:this._getTransformNodes(),geometries:this._getGeometries()}))})}loadAsync(e,s,t,n,r=""){return Promise.resolve().then(()=>(this._babylonScene=e,this._loadData(s),this._loadAsync(t,r,null,()=>{})))}_loadAsync(e,s,t,n){return Promise.resolve().then(()=>{this._rootUrl=e,this._uniqueRootUrl=!e.startsWith("file:")&&s?e:`${e}${Date.now()}/`,this._fileName=s,this._loadExtensions(),this._checkExtensions();const r=`${z[z.LOADING]} => ${z[z.READY]}`,o=`${z[z.LOADING]} => ${z[z.COMPLETE]}`;this._parent._startPerformanceCounter(r),this._parent._startPerformanceCounter(o),this._parent._setState(z.LOADING),this._extensionsOnLoading();const a=new Array,l=this._babylonScene.blockMaterialDirtyMechanism;if(this._babylonScene.blockMaterialDirtyMechanism=!0,!this.parent.loadOnlyMaterials){if(t)a.push(this.loadSceneAsync("/nodes",{nodes:t,index:-1}));else if(this._gltf.scene!=null||this._gltf.scenes&&this._gltf.scenes[0]){const d=p.Get("/scene",this._gltf.scenes,this._gltf.scene||0);a.push(this.loadSceneAsync(`/scenes/${d.index}`,d))}}if(!this.parent.skipMaterials&&this.parent.loadAllMaterials&&this._gltf.materials)for(let d=0;d<this._gltf.materials.length;++d){const h=this._gltf.materials[d],u="/materials/"+d,f=Z.TriangleFillMode;a.push(this._loadMaterialAsync(u,h,null,f,()=>{}))}return this._babylonScene.blockMaterialDirtyMechanism=l,this._parent.compileMaterials&&a.push(this._compileMaterialsAsync()),this._parent.compileShadowGenerators&&a.push(this._compileShadowGeneratorsAsync()),Promise.all(a).then(()=>(this._rootBabylonMesh&&this._rootBabylonMesh.setEnabled(!0),this._extensionsOnReady(),this._parent._setState(z.READY),this._startAnimations(),n())).then(d=>(this._parent._endPerformanceCounter(r),N.SetImmediate(()=>{this._disposed||Promise.all(this._completePromises).then(()=>{this._parent._endPerformanceCounter(o),this._parent._setState(z.COMPLETE),this._parent.onCompleteObservable.notifyObservers(void 0),this._parent.onCompleteObservable.clear(),this.dispose()},h=>{this._parent.onErrorObservable.notifyObservers(h),this._parent.onErrorObservable.clear(),this.dispose()})}),d))}).catch(r=>{throw this._disposed||(this._parent.onErrorObservable.notifyObservers(r),this._parent.onErrorObservable.clear(),this.dispose()),r})}_loadData(e){if(this._gltf=e.json,this._setupData(),e.bin){const s=this._gltf.buffers;if(s&&s[0]&&!s[0].uri){const t=s[0];(t.byteLength<e.bin.byteLength-3||t.byteLength>e.bin.byteLength)&&U.Warn(`Binary buffer length (${t.byteLength}) from JSON does not match chunk length (${e.bin.byteLength})`),this._bin=e.bin}else U.Warn("Unexpected BIN chunk")}}_setupData(){if(p.Assign(this._gltf.accessors),p.Assign(this._gltf.animations),p.Assign(this._gltf.buffers),p.Assign(this._gltf.bufferViews),p.Assign(this._gltf.cameras),p.Assign(this._gltf.images),p.Assign(this._gltf.materials),p.Assign(this._gltf.meshes),p.Assign(this._gltf.nodes),p.Assign(this._gltf.samplers),p.Assign(this._gltf.scenes),p.Assign(this._gltf.skins),p.Assign(this._gltf.textures),this._gltf.nodes){const e={};for(const t of this._gltf.nodes)if(t.children)for(const n of t.children)e[n]=t.index;const s=this._createRootNode();for(const t of this._gltf.nodes){const n=e[t.index];t.parent=n===void 0?s:this._gltf.nodes[n]}}}_loadExtensions(){for(const e in _._RegisteredExtensions){const s=_._RegisteredExtensions[e].factory(this);s.name!==e&&U.Warn(`The name of the glTF loader extension instance does not match the registered name: ${s.name} !== ${e}`),this._extensions.push(s),this._parent.onExtensionLoadedObservable.notifyObservers(s)}this._extensions.sort((e,s)=>(e.order||Number.MAX_VALUE)-(s.order||Number.MAX_VALUE)),this._parent.onExtensionLoadedObservable.clear()}_checkExtensions(){if(this._gltf.extensionsRequired){for(const e of this._gltf.extensionsRequired)if(!this._extensions.some(t=>t.name===e&&t.enabled))throw new Error(`Require extension ${e} is not available`)}}_createRootNode(){this._babylonScene._blockEntityCollection=!!this._assetContainer,this._rootBabylonMesh=new ce("__root__",this._babylonScene),this._rootBabylonMesh._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._rootBabylonMesh.setEnabled(!1);const e={_babylonTransformNode:this._rootBabylonMesh,index:-1};switch(this._parent.coordinateSystemMode){case me.AUTO:{this._babylonScene.useRightHandedSystem||(e.rotation=[0,1,0,0],e.scale=[1,1,-1],_._LoadTransform(e,this._rootBabylonMesh));break}case me.FORCE_RIGHT_HANDED:{this._babylonScene.useRightHandedSystem=!0;break}default:throw new Error(`Invalid coordinate system mode (${this._parent.coordinateSystemMode})`)}return this._parent.onMeshLoadedObservable.notifyObservers(this._rootBabylonMesh),e}loadSceneAsync(e,s){const t=this._extensionsLoadSceneAsync(e,s);if(t)return t;const n=new Array;if(this.logOpen(`${e} ${s.name||""}`),s.nodes)for(const r of s.nodes){const o=p.Get(`${e}/nodes/${r}`,this._gltf.nodes,r);n.push(this.loadNodeAsync(`/nodes/${o.index}`,o,a=>{a.parent=this._rootBabylonMesh}))}for(const r of this._postSceneLoadActions)r();return n.push(this._loadAnimationsAsync()),this.logClose(),Promise.all(n).then(()=>{})}_forEachPrimitive(e,s){if(e._primitiveBabylonMeshes)for(const t of e._primitiveBabylonMeshes)s(t)}_getGeometries(){const e=new Array,s=this._gltf.nodes;if(s)for(const t of s)this._forEachPrimitive(t,n=>{const r=n.geometry;r&&e.indexOf(r)===-1&&e.push(r)});return e}_getMeshes(){const e=new Array;this._rootBabylonMesh&&e.push(this._rootBabylonMesh);const s=this._gltf.nodes;if(s)for(const t of s)this._forEachPrimitive(t,n=>{e.push(n)});return e}_getTransformNodes(){const e=new Array,s=this._gltf.nodes;if(s)for(const t of s)t._babylonTransformNode&&t._babylonTransformNode.getClassName()==="TransformNode"&&e.push(t._babylonTransformNode),t._babylonTransformNodeForSkin&&e.push(t._babylonTransformNodeForSkin);return e}_getSkeletons(){const e=new Array,s=this._gltf.skins;if(s)for(const t of s)t._data&&e.push(t._data.babylonSkeleton);return e}_getAnimationGroups(){const e=new Array,s=this._gltf.animations;if(s)for(const t of s)t._babylonAnimationGroup&&e.push(t._babylonAnimationGroup);return e}_startAnimations(){switch(this._parent.animationStartMode){case le.NONE:break;case le.FIRST:{const e=this._getAnimationGroups();e.length!==0&&e[0].start(!0);break}case le.ALL:{const e=this._getAnimationGroups();for(const s of e)s.start(!0);break}default:{U.Error(`Invalid animation start mode (${this._parent.animationStartMode})`);return}}}loadNodeAsync(e,s,t=()=>{}){const n=this._extensionsLoadNodeAsync(e,s,t);if(n)return n;if(s._babylonTransformNode)throw new Error(`${e}: Invalid recursive node hierarchy`);const r=new Array;this.logOpen(`${e} ${s.name||""}`);const o=a=>{if(_.AddPointerMetadata(a,e),_._LoadTransform(s,a),s.camera!=null){const l=p.Get(`${e}/camera`,this._gltf.cameras,s.camera);r.push(this.loadCameraAsync(`/cameras/${l.index}`,l,c=>{c.parent=a}))}if(s.children)for(const l of s.children){const c=p.Get(`${e}/children/${l}`,this._gltf.nodes,l);r.push(this.loadNodeAsync(`/nodes/${c.index}`,c,d=>{d.parent=a}))}t(a)};if(s.mesh==null||s.skin!=null){const a=s.name||`node${s.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;const l=new ps(a,this._babylonScene);l._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,s.mesh==null?s._babylonTransformNode=l:s._babylonTransformNodeForSkin=l,o(l)}if(s.mesh!=null)if(s.skin==null){const a=p.Get(`${e}/mesh`,this._gltf.meshes,s.mesh);r.push(this._loadMeshAsync(`/meshes/${a.index}`,s,a,o))}else{const a=p.Get(`${e}/mesh`,this._gltf.meshes,s.mesh);r.push(this._loadMeshAsync(`/meshes/${a.index}`,s,a,l=>{const c=s._babylonTransformNodeForSkin;l.metadata=Ds(c.metadata,l.metadata||{});const d=p.Get(`${e}/skin`,this._gltf.skins,s.skin);r.push(this._loadSkinAsync(`/skins/${d.index}`,s,d,h=>{this._forEachPrimitive(s,u=>{u.skeleton=h}),this._postSceneLoadActions.push(()=>{if(d.skeleton!=null){const u=p.Get(`/skins/${d.index}/skeleton`,this._gltf.nodes,d.skeleton).parent;s.index===u.index?l.parent=c.parent:l.parent=u._babylonTransformNode}else l.parent=this._rootBabylonMesh;this._parent.onSkinLoadedObservable.notifyObservers({node:c,skinnedNode:l})})}))}))}return this.logClose(),Promise.all(r).then(()=>(this._forEachPrimitive(s,a=>{a.geometry&&a.geometry.useBoundingInfoFromGeometry?a._updateBoundingInfo():a.refreshBoundingInfo(!0)}),s._babylonTransformNode))}_loadMeshAsync(e,s,t,n){const r=t.primitives;if(!r||!r.length)throw new Error(`${e}: Primitives are missing`);r[0].index==null&&p.Assign(r);const o=new Array;this.logOpen(`${e} ${t.name||""}`);const a=s.name||`node${s.index}`;if(r.length===1){const l=t.primitives[0];o.push(this._loadMeshPrimitiveAsync(`${e}/primitives/${l.index}`,a,s,t,l,c=>{s._babylonTransformNode=c,s._primitiveBabylonMeshes=[c]}))}else{this._babylonScene._blockEntityCollection=!!this._assetContainer,s._babylonTransformNode=new ps(a,this._babylonScene),s._babylonTransformNode._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,s._primitiveBabylonMeshes=[];for(const l of r)o.push(this._loadMeshPrimitiveAsync(`${e}/primitives/${l.index}`,`${a}_primitive${l.index}`,s,t,l,c=>{c.parent=s._babylonTransformNode,s._primitiveBabylonMeshes.push(c)}))}return n(s._babylonTransformNode),this.logClose(),Promise.all(o).then(()=>s._babylonTransformNode)}_loadMeshPrimitiveAsync(e,s,t,n,r,o){const a=this._extensionsLoadMeshPrimitiveAsync(e,s,t,n,r,o);if(a)return a;this.logOpen(`${e}`);const l=this._disableInstancedMesh===0&&this._parent.createInstances&&t.skin==null&&!n.primitives[0].targets;let c,d;if(l&&r._instanceData)this._babylonScene._blockEntityCollection=!!this._assetContainer,c=r._instanceData.babylonSourceMesh.createInstance(s),c._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,d=r._instanceData.promise;else{const h=new Array;this._babylonScene._blockEntityCollection=!!this._assetContainer;const u=new ce(s,this._babylonScene);u._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,u.overrideMaterialSideOrientation=this._babylonScene.useRightHandedSystem?Z.CounterClockWiseSideOrientation:Z.ClockWiseSideOrientation,this._createMorphTargets(e,t,n,r,u),h.push(this._loadVertexDataAsync(e,r,u).then(m=>this._loadMorphTargetsAsync(e,r,u,m).then(()=>{this._disposed||(this._babylonScene._blockEntityCollection=!!this._assetContainer,m.applyToMesh(u),m._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1)})));const f=_._GetDrawMode(e,r.mode);if(r.material==null){let m=this._defaultBabylonMaterialData[f];m||(m=this._createDefaultMaterial("__GLTFLoader._default",f),this._parent.onMaterialLoadedObservable.notifyObservers(m),this._defaultBabylonMaterialData[f]=m),u.material=m}else if(!this.parent.skipMaterials){const m=p.Get(`${e}/material`,this._gltf.materials,r.material);h.push(this._loadMaterialAsync(`/materials/${m.index}`,m,u,f,g=>{u.material=g}))}d=Promise.all(h),l&&(r._instanceData={babylonSourceMesh:u,promise:d}),c=u}return _.AddPointerMetadata(c,e),this._parent.onMeshLoadedObservable.notifyObservers(c),o(c),this.logClose(),d.then(()=>c)}_loadVertexDataAsync(e,s,t){const n=this._extensionsLoadVertexDataAsync(e,s,t);if(n)return n;const r=s.attributes;if(!r)throw new Error(`${e}: Attributes are missing`);const o=new Array,a=new cs(t.name,this._babylonScene);if(s.indices==null)t.isUnIndexed=!0;else{const c=p.Get(`${e}/indices`,this._gltf.accessors,s.indices);o.push(this._loadIndicesAccessorAsync(`/accessors/${c.index}`,c).then(d=>{a.setIndices(d)}))}const l=(c,d,h)=>{if(r[c]==null)return;t._delayInfo=t._delayInfo||[],t._delayInfo.indexOf(d)===-1&&t._delayInfo.push(d);const u=p.Get(`${e}/attributes/${c}`,this._gltf.accessors,r[c]);o.push(this._loadVertexAccessorAsync(`/accessors/${u.index}`,u,d).then(f=>{if(f.getKind()===x.PositionKind&&!this.parent.alwaysComputeBoundingBox&&!t.skeleton&&u.min&&u.max){const m=X.Vector3[0].copyFromFloats(...u.min),g=X.Vector3[1].copyFromFloats(...u.max);if(u.normalized&&u.componentType!==5126){let E=1;switch(u.componentType){case 5120:E=127;break;case 5121:E=255;break;case 5122:E=32767;break;case 5123:E=65535;break}const A=1/E;m.scaleInPlace(A),g.scaleInPlace(A)}a._boundingInfo=new it(m,g),a.useBoundingInfoFromGeometry=!0}a.setVerticesBuffer(f,u.count)})),d==x.MatricesIndicesExtraKind&&(t.numBoneInfluencers=8),h&&h(u)};return l("POSITION",x.PositionKind),l("NORMAL",x.NormalKind),l("TANGENT",x.TangentKind),l("TEXCOORD_0",x.UVKind),l("TEXCOORD_1",x.UV2Kind),l("TEXCOORD_2",x.UV3Kind),l("TEXCOORD_3",x.UV4Kind),l("TEXCOORD_4",x.UV5Kind),l("TEXCOORD_5",x.UV6Kind),l("JOINTS_0",x.MatricesIndicesKind),l("WEIGHTS_0",x.MatricesWeightsKind),l("JOINTS_1",x.MatricesIndicesExtraKind),l("WEIGHTS_1",x.MatricesWeightsExtraKind),l("COLOR_0",x.ColorKind,c=>{c.type==="VEC4"&&(t.hasVertexAlpha=!0)}),Promise.all(o).then(()=>a)}_createMorphTargets(e,s,t,n,r){if(!n.targets)return;if(s._numMorphTargets==null)s._numMorphTargets=n.targets.length;else if(n.targets.length!==s._numMorphTargets)throw new Error(`${e}: Primitives do not have the same number of targets`);const o=t.extras?t.extras.targetNames:null;this._babylonScene._blockEntityCollection=!!this._assetContainer,r.morphTargetManager=new Qs(this._babylonScene),r.morphTargetManager._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,r.morphTargetManager.areUpdatesFrozen=!0;for(let a=0;a<n.targets.length;a++){const l=s.weights?s.weights[a]:t.weights?t.weights[a]:0,c=o?o[a]:`morphTarget${a}`;r.morphTargetManager.addTarget(new et(c,l,r.getScene()))}}_loadMorphTargetsAsync(e,s,t,n){if(!s.targets)return Promise.resolve();const r=new Array,o=t.morphTargetManager;for(let a=0;a<o.numTargets;a++){const l=o.getTarget(a);r.push(this._loadMorphTargetVertexDataAsync(`${e}/targets/${a}`,n,s.targets[a],l))}return Promise.all(r).then(()=>{o.areUpdatesFrozen=!1})}_loadMorphTargetVertexDataAsync(e,s,t,n){const r=new Array,o=(a,l,c)=>{if(t[a]==null)return;const d=s.getVertexBuffer(l);if(!d)return;const h=p.Get(`${e}/${a}`,this._gltf.accessors,t[a]);r.push(this._loadFloatAccessorAsync(`/accessors/${h.index}`,h).then(u=>{c(d,u)}))};return o("POSITION",x.PositionKind,(a,l)=>{const c=new Float32Array(l.length);a.forEach(l.length,(d,h)=>{c[h]=l[h]+d}),n.setPositions(c)}),o("NORMAL",x.NormalKind,(a,l)=>{const c=new Float32Array(l.length);a.forEach(c.length,(d,h)=>{c[h]=l[h]+d}),n.setNormals(c)}),o("TANGENT",x.TangentKind,(a,l)=>{const c=new Float32Array(l.length/3*4);let d=0;a.forEach(l.length/3*4,(h,u)=>{(u+1)%4!==0&&(c[d]=l[d]+h,d++)}),n.setTangents(c)}),Promise.all(r).then(()=>{})}static _LoadTransform(e,s){if(e.skin!=null)return;let t=T.Zero(),n=J.Identity(),r=T.One();e.matrix?q.FromArray(e.matrix).decompose(r,n,t):(e.translation&&(t=T.FromArray(e.translation)),e.rotation&&(n=J.FromArray(e.rotation)),e.scale&&(r=T.FromArray(e.scale))),s.position=t,s.rotationQuaternion=n,s.scaling=r}_loadSkinAsync(e,s,t,n){const r=this._extensionsLoadSkinAsync(e,s,t);if(r)return r;if(t._data)return n(t._data.babylonSkeleton),t._data.promise;const o=`skeleton${t.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;const a=new rs(t.name||o,o,this._babylonScene);a._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._loadBones(e,t,a);const l=this._loadSkinInverseBindMatricesDataAsync(e,t).then(c=>{this._updateBoneMatrices(a,c)});return t._data={babylonSkeleton:a,promise:l},n(a),l}_loadBones(e,s,t){if(s.skeleton==null||this._parent.alwaysComputeSkeletonRootNode){const r=this._findSkeletonRootNode(`${e}/joints`,s.joints);if(r)if(s.skeleton===void 0)s.skeleton=r.index;else{const o=(l,c)=>{for(;c.parent;c=c.parent)if(c.parent===l)return!0;return!1},a=p.Get(`${e}/skeleton`,this._gltf.nodes,s.skeleton);a!==r&&!o(a,r)&&(U.Warn(`${e}/skeleton: Overriding with nearest common ancestor as skeleton node is not a common root`),s.skeleton=r.index)}else U.Warn(`${e}: Failed to find common root`)}const n={};for(const r of s.joints){const o=p.Get(`${e}/joints/${r}`,this._gltf.nodes,r);this._loadBone(o,s,t,n)}}_findSkeletonRootNode(e,s){if(s.length===0)return null;const t={};for(const r of s){const o=new Array;let a=p.Get(`${e}/${r}`,this._gltf.nodes,r);for(;a.index!==-1;)o.unshift(a),a=a.parent;t[r]=o}let n=null;for(let r=0;;++r){let o=t[s[0]];if(r>=o.length)return n;const a=o[r];for(let l=1;l<s.length;++l)if(o=t[s[l]],r>=o.length||a!==o[r])return n;n=a}}_loadBone(e,s,t,n){let r=n[e.index];if(r)return r;let o=null;e.index!==s.skeleton&&(e.parent&&e.parent.index!==-1?o=this._loadBone(e.parent,s,t,n):s.skeleton!==void 0&&U.Warn(`/skins/${s.index}/skeleton: Skeleton node is not a common root`));const a=s.joints.indexOf(e.index);return r=new Ae(e.name||`joint${e.index}`,t,o,this._getNodeMatrix(e),null,null,a),n[e.index]=r,this._postSceneLoadActions.push(()=>{r.linkTransformNode(e._babylonTransformNode)}),r}_loadSkinInverseBindMatricesDataAsync(e,s){if(s.inverseBindMatrices==null)return Promise.resolve(null);const t=p.Get(`${e}/inverseBindMatrices`,this._gltf.accessors,s.inverseBindMatrices);return this._loadFloatAccessorAsync(`/accessors/${t.index}`,t)}_updateBoneMatrices(e,s){for(const t of e.bones){const n=q.Identity(),r=t._index;s&&r!==-1&&(q.FromArrayToRef(s,r*16,n),n.invertToRef(n));const o=t.getParent();o&&n.multiplyToRef(o.getInvertedAbsoluteTransform(),n),t.updateMatrix(n,!1,!1),t._updateDifferenceMatrix(void 0,!1)}}_getNodeMatrix(e){return e.matrix?q.FromArray(e.matrix):q.Compose(e.scale?T.FromArray(e.scale):T.One(),e.rotation?J.FromArray(e.rotation):J.Identity(),e.translation?T.FromArray(e.translation):T.Zero())}loadCameraAsync(e,s,t=()=>{}){const n=this._extensionsLoadCameraAsync(e,s,t);if(n)return n;const r=new Array;this.logOpen(`${e} ${s.name||""}`),this._babylonScene._blockEntityCollection=!!this._assetContainer;const o=new Ce(s.name||`camera${s.index}`,T.Zero(),this._babylonScene,!1);switch(o._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,o.ignoreParentScaling=!0,s._babylonCamera=o,o.rotation=new T(0,Math.PI,0),s.type){case"perspective":{const a=s.perspective;if(!a)throw new Error(`${e}: Camera perspective properties are missing`);o.fov=a.yfov,o.minZ=a.znear,o.maxZ=a.zfar||0;break}case"orthographic":{if(!s.orthographic)throw new Error(`${e}: Camera orthographic properties are missing`);o.mode=vs.ORTHOGRAPHIC_CAMERA,o.orthoLeft=-s.orthographic.xmag,o.orthoRight=s.orthographic.xmag,o.orthoBottom=-s.orthographic.ymag,o.orthoTop=s.orthographic.ymag,o.minZ=s.orthographic.znear,o.maxZ=s.orthographic.zfar;break}default:throw new Error(`${e}: Invalid camera type (${s.type})`)}return _.AddPointerMetadata(o,e),this._parent.onCameraLoadedObservable.notifyObservers(o),t(o),this.logClose(),Promise.all(r).then(()=>o)}_loadAnimationsAsync(){const e=this._gltf.animations;if(!e)return Promise.resolve();const s=new Array;for(let t=0;t<e.length;t++){const n=e[t];s.push(this.loadAnimationAsync(`/animations/${n.index}`,n).then(r=>{r.targetedAnimations.length===0&&r.dispose()}))}return Promise.all(s).then(()=>{})}loadAnimationAsync(e,s){const t=this._extensionsLoadAnimationAsync(e,s);if(t)return t;this._babylonScene._blockEntityCollection=!!this._assetContainer;const n=new st(s.name||`animation${s.index}`,this._babylonScene);n._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,s._babylonAnimationGroup=n;const r=new Array;p.Assign(s.channels),p.Assign(s.samplers);for(const o of s.channels)r.push(this._loadAnimationChannelAsync(`${e}/channels/${o.index}`,e,s,o,(a,l)=>{a.animations=a.animations||[],a.animations.push(l),n.addTargetedAnimation(l,a)}));return Promise.all(r).then(()=>(n.normalize(0),n))}_loadAnimationChannelAsync(e,s,t,n,r){const o=this._extensionsLoadAnimationChannelAsync(e,s,t,n,r);if(o)return o;if(n.target.node==null)return Promise.resolve();const a=p.Get(`${e}/target/node`,this._gltf.nodes,n.target.node);if(n.target.path==="weights"&&!a._numMorphTargets||n.target.path!=="weights"&&!a._babylonTransformNode)return Promise.resolve();let l;switch(n.target.path){case"translation":{l=fe.translation;break}case"rotation":{l=fe.rotation;break}case"scale":{l=fe.scale;break}case"weights":{l=fe.weights;break}default:throw new Error(`${e}/target/path: Invalid value (${n.target.path})`)}const c={target:a,properties:l};return this._loadAnimationChannelFromTargetInfoAsync(e,s,t,n,c,r)}_loadAnimationChannelFromTargetInfoAsync(e,s,t,n,r,o){const a=this.parent.targetFps,l=1/a,c=p.Get(`${e}/sampler`,t.samplers,n.sampler);return this._loadAnimationSamplerAsync(`${s}/samplers/${n.sampler}`,c).then(d=>{let h=0;for(const u of r.properties){const f=u.getStride(r.target),m=d.input,g=d.output,E=new Array(m.length);let A=0;switch(d.interpolation){case"STEP":{for(let C=0;C<m.length;C++){const I=u.getValue(r.target,g,A,1);A+=f,E[C]={frame:m[C]*a,value:I,interpolation:tt.STEP}}break}case"CUBICSPLINE":{for(let C=0;C<m.length;C++){const I=u.getValue(r.target,g,A,l);A+=f;const M=u.getValue(r.target,g,A,1);A+=f;const O=u.getValue(r.target,g,A,l);A+=f,E[C]={frame:m[C]*a,inTangent:I,value:M,outTangent:O}}break}case"LINEAR":{for(let C=0;C<m.length;C++){const I=u.getValue(r.target,g,A,1);A+=f,E[C]={frame:m[C]*a,value:I}}break}}if(A>0){const C=`${t.name||`animation${t.index}`}_channel${n.index}_${h}`;u.buildAnimations(r.target,C,a,E,(I,M)=>{++h,o(I,M)})}}})}_loadAnimationSamplerAsync(e,s){if(s._data)return s._data;const t=s.interpolation||"LINEAR";switch(t){case"STEP":case"LINEAR":case"CUBICSPLINE":break;default:throw new Error(`${e}/interpolation: Invalid value (${s.interpolation})`)}const n=p.Get(`${e}/input`,this._gltf.accessors,s.input),r=p.Get(`${e}/output`,this._gltf.accessors,s.output);return s._data=Promise.all([this._loadFloatAccessorAsync(`/accessors/${n.index}`,n),this._loadFloatAccessorAsync(`/accessors/${r.index}`,r)]).then(([o,a])=>({input:o,interpolation:t,output:a})),s._data}loadBufferAsync(e,s,t,n){const r=this._extensionsLoadBufferAsync(e,s,t,n);if(r)return r;if(!s._data)if(s.uri)s._data=this.loadUriAsync(`${e}/uri`,s,s.uri);else{if(!this._bin)throw new Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);s._data=this._bin.readAsync(0,s.byteLength)}return s._data.then(o=>{try{return new Uint8Array(o.buffer,o.byteOffset+t,n)}catch(a){throw new Error(`${e}: ${a.message}`)}})}loadBufferViewAsync(e,s){const t=this._extensionsLoadBufferViewAsync(e,s);if(t)return t;if(s._data)return s._data;const n=p.Get(`${e}/buffer`,this._gltf.buffers,s.buffer);return s._data=this.loadBufferAsync(`/buffers/${n.index}`,n,s.byteOffset||0,s.byteLength),s._data}_loadAccessorAsync(e,s,t){if(s._data)return s._data;const n=_._GetNumComponents(e,s.type),r=n*x.GetTypeByteLength(s.componentType),o=n*s.count;if(s.bufferView==null)s._data=Promise.resolve(new t(o));else{const a=p.Get(`${e}/bufferView`,this._gltf.bufferViews,s.bufferView);s._data=this.loadBufferViewAsync(`/bufferViews/${a.index}`,a).then(l=>{if(s.componentType===5126&&!s.normalized&&(!a.byteStride||a.byteStride===r))return _._GetTypedArray(e,s.componentType,l,s.byteOffset,o);{const c=new t(o);return x.ForEach(l,s.byteOffset||0,a.byteStride||r,n,s.componentType,c.length,s.normalized||!1,(d,h)=>{c[h]=d}),c}})}if(s.sparse){const a=s.sparse;s._data=s._data.then(l=>{const c=l,d=p.Get(`${e}/sparse/indices/bufferView`,this._gltf.bufferViews,a.indices.bufferView),h=p.Get(`${e}/sparse/values/bufferView`,this._gltf.bufferViews,a.values.bufferView);return Promise.all([this.loadBufferViewAsync(`/bufferViews/${d.index}`,d),this.loadBufferViewAsync(`/bufferViews/${h.index}`,h)]).then(([u,f])=>{const m=_._GetTypedArray(`${e}/sparse/indices`,a.indices.componentType,u,a.indices.byteOffset,a.count),g=n*a.count;let E;if(s.componentType===5126&&!s.normalized)E=_._GetTypedArray(`${e}/sparse/values`,s.componentType,f,a.values.byteOffset,g);else{const C=_._GetTypedArray(`${e}/sparse/values`,s.componentType,f,a.values.byteOffset,g);E=new t(g),x.ForEach(C,0,r,n,s.componentType,E.length,s.normalized||!1,(I,M)=>{E[M]=I})}let A=0;for(let C=0;C<m.length;C++){let I=m[C]*n;for(let M=0;M<n;M++)c[I++]=E[A++]}return c})})}return s._data}_loadFloatAccessorAsync(e,s){return this._loadAccessorAsync(e,s,Float32Array)}_loadIndicesAccessorAsync(e,s){if(s.type!=="SCALAR")throw new Error(`${e}/type: Invalid value ${s.type}`);if(s.componentType!==5121&&s.componentType!==5123&&s.componentType!==5125)throw new Error(`${e}/componentType: Invalid value ${s.componentType}`);if(s._data)return s._data;if(s.sparse){const t=_._GetTypedArrayConstructor(`${e}/componentType`,s.componentType);s._data=this._loadAccessorAsync(e,s,t)}else{const t=p.Get(`${e}/bufferView`,this._gltf.bufferViews,s.bufferView);s._data=this.loadBufferViewAsync(`/bufferViews/${t.index}`,t).then(n=>_._GetTypedArray(e,s.componentType,n,s.byteOffset,s.count))}return s._data}_loadVertexBufferViewAsync(e){if(e._babylonBuffer)return e._babylonBuffer;const s=this._babylonScene.getEngine();return e._babylonBuffer=this.loadBufferViewAsync(`/bufferViews/${e.index}`,e).then(t=>new nt(s,t,!1)),e._babylonBuffer}_loadVertexAccessorAsync(e,s,t){var n;if(!((n=s._babylonVertexBuffer)===null||n===void 0)&&n[t])return s._babylonVertexBuffer[t];s._babylonVertexBuffer||(s._babylonVertexBuffer={});const r=this._babylonScene.getEngine();if(s.sparse)s._babylonVertexBuffer[t]=this._loadFloatAccessorAsync(e,s).then(o=>new x(r,o,t,!1));else if(t===x.MatricesIndicesKind||t===x.MatricesIndicesExtraKind)s._babylonVertexBuffer[t]=this._loadFloatAccessorAsync(e,s).then(o=>new x(r,o,t,!1));else{const o=p.Get(`${e}/bufferView`,this._gltf.bufferViews,s.bufferView);s._babylonVertexBuffer[t]=this._loadVertexBufferViewAsync(o).then(a=>{const l=_._GetNumComponents(e,s.type);return new x(r,a,t,!1,!1,o.byteStride,!1,s.byteOffset,l,s.componentType,s.normalized,!0,1,!0)})}return s._babylonVertexBuffer[t]}_loadMaterialMetallicRoughnessPropertiesAsync(e,s,t){if(!(t instanceof V))throw new Error(`${e}: Material type not supported`);const n=new Array;return s&&(s.baseColorFactor?(t.albedoColor=L.FromArray(s.baseColorFactor),t.alpha=s.baseColorFactor[3]):t.albedoColor=L.White(),t.metallic=s.metallicFactor==null?1:s.metallicFactor,t.roughness=s.roughnessFactor==null?1:s.roughnessFactor,s.baseColorTexture&&n.push(this.loadTextureInfoAsync(`${e}/baseColorTexture`,s.baseColorTexture,r=>{r.name=`${t.name} (Base Color)`,t.albedoTexture=r})),s.metallicRoughnessTexture&&(s.metallicRoughnessTexture.nonColorData=!0,n.push(this.loadTextureInfoAsync(`${e}/metallicRoughnessTexture`,s.metallicRoughnessTexture,r=>{r.name=`${t.name} (Metallic Roughness)`,t.metallicTexture=r})),t.useMetallnessFromMetallicTextureBlue=!0,t.useRoughnessFromMetallicTextureGreen=!0,t.useRoughnessFromMetallicTextureAlpha=!1)),Promise.all(n).then(()=>{})}_loadMaterialAsync(e,s,t,n,r=()=>{}){const o=this._extensionsLoadMaterialAsync(e,s,t,n,r);if(o)return o;s._data=s._data||{};let a=s._data[n];if(!a){this.logOpen(`${e} ${s.name||""}`);const l=this.createMaterial(e,s,n);a={babylonMaterial:l,babylonMeshes:[],promise:this.loadMaterialPropertiesAsync(e,s,l)},s._data[n]=a,_.AddPointerMetadata(l,e),this._parent.onMaterialLoadedObservable.notifyObservers(l),this.logClose()}return t&&(a.babylonMeshes.push(t),t.onDisposeObservable.addOnce(()=>{const l=a.babylonMeshes.indexOf(t);l!==-1&&a.babylonMeshes.splice(l,1)})),r(a.babylonMaterial),a.promise.then(()=>a.babylonMaterial)}_createDefaultMaterial(e,s){this._babylonScene._blockEntityCollection=!!this._assetContainer;const t=new V(e,this._babylonScene);return t._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t.fillMode=s,t.enableSpecularAntiAliasing=!0,t.useRadianceOverAlpha=!this._parent.transparencyAsCoverage,t.useSpecularOverAlpha=!this._parent.transparencyAsCoverage,t.transparencyMode=V.PBRMATERIAL_OPAQUE,t.metallic=1,t.roughness=1,t}createMaterial(e,s,t){const n=this._extensionsCreateMaterial(e,s,t);if(n)return n;const r=s.name||`material${s.index}`;return this._createDefaultMaterial(r,t)}loadMaterialPropertiesAsync(e,s,t){const n=this._extensionsLoadMaterialPropertiesAsync(e,s,t);if(n)return n;const r=new Array;return r.push(this.loadMaterialBasePropertiesAsync(e,s,t)),s.pbrMetallicRoughness&&r.push(this._loadMaterialMetallicRoughnessPropertiesAsync(`${e}/pbrMetallicRoughness`,s.pbrMetallicRoughness,t)),this.loadMaterialAlphaProperties(e,s,t),Promise.all(r).then(()=>{})}loadMaterialBasePropertiesAsync(e,s,t){if(!(t instanceof V))throw new Error(`${e}: Material type not supported`);const n=new Array;return t.emissiveColor=s.emissiveFactor?L.FromArray(s.emissiveFactor):new L(0,0,0),s.doubleSided&&(t.backFaceCulling=!1,t.twoSidedLighting=!0),s.normalTexture&&(s.normalTexture.nonColorData=!0,n.push(this.loadTextureInfoAsync(`${e}/normalTexture`,s.normalTexture,r=>{r.name=`${t.name} (Normal)`,t.bumpTexture=r})),t.invertNormalMapX=!this._babylonScene.useRightHandedSystem,t.invertNormalMapY=this._babylonScene.useRightHandedSystem,s.normalTexture.scale!=null&&t.bumpTexture&&(t.bumpTexture.level=s.normalTexture.scale),t.forceIrradianceInFragment=!0),s.occlusionTexture&&(s.occlusionTexture.nonColorData=!0,n.push(this.loadTextureInfoAsync(`${e}/occlusionTexture`,s.occlusionTexture,r=>{r.name=`${t.name} (Occlusion)`,t.ambientTexture=r})),t.useAmbientInGrayScale=!0,s.occlusionTexture.strength!=null&&(t.ambientTextureStrength=s.occlusionTexture.strength)),s.emissiveTexture&&n.push(this.loadTextureInfoAsync(`${e}/emissiveTexture`,s.emissiveTexture,r=>{r.name=`${t.name} (Emissive)`,t.emissiveTexture=r})),Promise.all(n).then(()=>{})}loadMaterialAlphaProperties(e,s,t){if(!(t instanceof V))throw new Error(`${e}: Material type not supported`);switch(s.alphaMode||"OPAQUE"){case"OPAQUE":{t.transparencyMode=V.PBRMATERIAL_OPAQUE;break}case"MASK":{t.transparencyMode=V.PBRMATERIAL_ALPHATEST,t.alphaCutOff=s.alphaCutoff==null?.5:s.alphaCutoff,t.albedoTexture&&(t.albedoTexture.hasAlpha=!0);break}case"BLEND":{t.transparencyMode=V.PBRMATERIAL_ALPHABLEND,t.albedoTexture&&(t.albedoTexture.hasAlpha=!0,t.useAlphaFromAlbedoTexture=!0);break}default:throw new Error(`${e}/alphaMode: Invalid value (${s.alphaMode})`)}}loadTextureInfoAsync(e,s,t=()=>{}){const n=this._extensionsLoadTextureInfoAsync(e,s,t);if(n)return n;if(this.logOpen(`${e}`),s.texCoord>=6)throw new Error(`${e}/texCoord: Invalid value (${s.texCoord})`);const r=p.Get(`${e}/index`,this._gltf.textures,s.index);r._textureInfo=s;const o=this._loadTextureAsync(`/textures/${s.index}`,r,a=>{a.coordinatesIndex=s.texCoord||0,_.AddPointerMetadata(a,e),this._parent.onTextureLoadedObservable.notifyObservers(a),t(a)});return this.logClose(),o}_loadTextureAsync(e,s,t=()=>{}){const n=this._extensionsLoadTextureAsync(e,s,t);if(n)return n;this.logOpen(`${e} ${s.name||""}`);const r=s.sampler==null?_.DefaultSampler:p.Get(`${e}/sampler`,this._gltf.samplers,s.sampler),o=p.Get(`${e}/source`,this._gltf.images,s.source),a=this._createTextureAsync(e,r,o,t,void 0,!s._textureInfo.nonColorData);return this.logClose(),a}_createTextureAsync(e,s,t,n=()=>{},r,o){const a=this._loadSampler(`/samplers/${s.index}`,s),l=new Array,c=new ue;this._babylonScene._blockEntityCollection=!!this._assetContainer;const d={noMipmap:a.noMipMaps,invertY:!1,samplingMode:a.samplingMode,onLoad:()=>{this._disposed||c.resolve()},onError:(u,f)=>{this._disposed||c.reject(new Error(`${e}: ${f&&f.message?f.message:u||"Failed to load texture"}`))},mimeType:t.mimeType,loaderOptions:r,useSRGBBuffer:!!o&&this._parent.useSRGBBuffers},h=new v(null,this._babylonScene,d);return h._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,l.push(c.promise),l.push(this.loadImageAsync(`/images/${t.index}`,t).then(u=>{const f=t.uri||`${this._fileName}#image${t.index}`,m=`data:${this._uniqueRootUrl}${f}`;h.updateURL(m,u)})),h.wrapU=a.wrapU,h.wrapV=a.wrapV,n(h),Promise.all(l).then(()=>h)}_loadSampler(e,s){return s._data||(s._data={noMipMaps:s.minFilter===9728||s.minFilter===9729,samplingMode:_._GetTextureSamplingMode(e,s),wrapU:_._GetTextureWrapMode(`${e}/wrapS`,s.wrapS),wrapV:_._GetTextureWrapMode(`${e}/wrapT`,s.wrapT)}),s._data}loadImageAsync(e,s){if(!s._data){if(this.logOpen(`${e} ${s.name||""}`),s.uri)s._data=this.loadUriAsync(`${e}/uri`,s,s.uri);else{const t=p.Get(`${e}/bufferView`,this._gltf.bufferViews,s.bufferView);s._data=this.loadBufferViewAsync(`/bufferViews/${t.index}`,t)}this.logClose()}return s._data}loadUriAsync(e,s,t){const n=this._extensionsLoadUriAsync(e,s,t);if(n)return n;if(!_._ValidateUri(t))throw new Error(`${e}: '${t}' is invalid`);if(rt(t)){const r=new Uint8Array(Is(t));return this.log(`${e}: Decoded ${t.substr(0,64)}... (${r.length} bytes)`),Promise.resolve(r)}return this.log(`${e}: Loading ${t}`),this._parent.preprocessUrlAsync(this._rootUrl+t).then(r=>new Promise((o,a)=>{this._parent._loadFile(this._babylonScene,r,l=>{this._disposed||(this.log(`${e}: Loaded ${t} (${l.byteLength} bytes)`),o(new Uint8Array(l)))},!0,l=>{a(new ot(`${e}: Failed to load '${t}'${l?": "+l.status+" "+l.statusText:""}`,l))})}))}static AddPointerMetadata(e,s){e.metadata=e.metadata||{};const t=e._internalMetadata=e._internalMetadata||{},n=t.gltf=t.gltf||{};(n.pointers=n.pointers||[]).push(s)}static _GetTextureWrapMode(e,s){switch(s=s??10497,s){case 33071:return v.CLAMP_ADDRESSMODE;case 33648:return v.MIRROR_ADDRESSMODE;case 10497:return v.WRAP_ADDRESSMODE;default:return U.Warn(`${e}: Invalid value (${s})`),v.WRAP_ADDRESSMODE}}static _GetTextureSamplingMode(e,s){const t=s.magFilter==null?9729:s.magFilter,n=s.minFilter==null?9987:s.minFilter;if(t===9729)switch(n){case 9728:return v.LINEAR_NEAREST;case 9729:return v.LINEAR_LINEAR;case 9984:return v.LINEAR_NEAREST_MIPNEAREST;case 9985:return v.LINEAR_LINEAR_MIPNEAREST;case 9986:return v.LINEAR_NEAREST_MIPLINEAR;case 9987:return v.LINEAR_LINEAR_MIPLINEAR;default:return U.Warn(`${e}/minFilter: Invalid value (${n})`),v.LINEAR_LINEAR_MIPLINEAR}else switch(t!==9728&&U.Warn(`${e}/magFilter: Invalid value (${t})`),n){case 9728:return v.NEAREST_NEAREST;case 9729:return v.NEAREST_LINEAR;case 9984:return v.NEAREST_NEAREST_MIPNEAREST;case 9985:return v.NEAREST_LINEAR_MIPNEAREST;case 9986:return v.NEAREST_NEAREST_MIPLINEAR;case 9987:return v.NEAREST_LINEAR_MIPLINEAR;default:return U.Warn(`${e}/minFilter: Invalid value (${n})`),v.NEAREST_NEAREST_MIPNEAREST}}static _GetTypedArrayConstructor(e,s){switch(s){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:throw new Error(`${e}: Invalid component type ${s}`)}}static _GetTypedArray(e,s,t,n,r){const o=t.buffer;n=t.byteOffset+(n||0);const a=_._GetTypedArrayConstructor(`${e}/componentType`,s),l=x.GetTypeByteLength(s);return n%l!==0?(U.Warn(`${e}: Copying buffer as byte offset (${n}) is not a multiple of component type byte length (${l})`),new a(o.slice(n,n+r*l),0)):new a(o,n,r)}static _GetNumComponents(e,s){switch(s){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}throw new Error(`${e}: Invalid type (${s})`)}static _ValidateUri(e){return N.IsBase64(e)||e.indexOf("..")===-1}static _GetDrawMode(e,s){switch(s==null&&(s=4),s){case 0:return Z.PointListDrawMode;case 1:return Z.LineListDrawMode;case 2:return Z.LineLoopDrawMode;case 3:return Z.LineStripDrawMode;case 4:return Z.TriangleFillMode;case 5:return Z.TriangleStripDrawMode;case 6:return Z.TriangleFanDrawMode}throw new Error(`${e}: Invalid mesh primitive mode (${s})`)}_compileMaterialsAsync(){this._parent._startPerformanceCounter("Compile materials");const e=new Array;if(this._gltf.materials){for(const s of this._gltf.materials)if(s._data)for(const t in s._data){const n=s._data[t];for(const r of n.babylonMeshes){r.computeWorldMatrix(!0);const o=n.babylonMaterial;e.push(o.forceCompilationAsync(r)),e.push(o.forceCompilationAsync(r,{useInstances:!0})),this._parent.useClipPlane&&(e.push(o.forceCompilationAsync(r,{clipPlane:!0})),e.push(o.forceCompilationAsync(r,{clipPlane:!0,useInstances:!0})))}}}return Promise.all(e).then(()=>{this._parent._endPerformanceCounter("Compile materials")})}_compileShadowGeneratorsAsync(){this._parent._startPerformanceCounter("Compile shadow generators");const e=new Array,s=this._babylonScene.lights;for(const t of s){const n=t.getShadowGenerator();n&&e.push(n.forceCompilationAsync())}return Promise.all(e).then(()=>{this._parent._endPerformanceCounter("Compile shadow generators")})}_forEachExtensions(e){for(const s of this._extensions)s.enabled&&e(s)}_applyExtensions(e,s,t){for(const n of this._extensions)if(n.enabled){const r=`${n.name}.${s}`,o=e;o._activeLoaderExtensionFunctions=o._activeLoaderExtensionFunctions||{};const a=o._activeLoaderExtensionFunctions;if(!a[r]){a[r]=!0;try{const l=t(n);if(l)return l}finally{delete a[r]}}}return null}_extensionsOnLoading(){this._forEachExtensions(e=>e.onLoading&&e.onLoading())}_extensionsOnReady(){this._forEachExtensions(e=>e.onReady&&e.onReady())}_extensionsLoadSceneAsync(e,s){return this._applyExtensions(s,"loadScene",t=>t.loadSceneAsync&&t.loadSceneAsync(e,s))}_extensionsLoadNodeAsync(e,s,t){return this._applyExtensions(s,"loadNode",n=>n.loadNodeAsync&&n.loadNodeAsync(e,s,t))}_extensionsLoadCameraAsync(e,s,t){return this._applyExtensions(s,"loadCamera",n=>n.loadCameraAsync&&n.loadCameraAsync(e,s,t))}_extensionsLoadVertexDataAsync(e,s,t){return this._applyExtensions(s,"loadVertexData",n=>n._loadVertexDataAsync&&n._loadVertexDataAsync(e,s,t))}_extensionsLoadMeshPrimitiveAsync(e,s,t,n,r,o){return this._applyExtensions(r,"loadMeshPrimitive",a=>a._loadMeshPrimitiveAsync&&a._loadMeshPrimitiveAsync(e,s,t,n,r,o))}_extensionsLoadMaterialAsync(e,s,t,n,r){return this._applyExtensions(s,"loadMaterial",o=>o._loadMaterialAsync&&o._loadMaterialAsync(e,s,t,n,r))}_extensionsCreateMaterial(e,s,t){return this._applyExtensions(s,"createMaterial",n=>n.createMaterial&&n.createMaterial(e,s,t))}_extensionsLoadMaterialPropertiesAsync(e,s,t){return this._applyExtensions(s,"loadMaterialProperties",n=>n.loadMaterialPropertiesAsync&&n.loadMaterialPropertiesAsync(e,s,t))}_extensionsLoadTextureInfoAsync(e,s,t){return this._applyExtensions(s,"loadTextureInfo",n=>n.loadTextureInfoAsync&&n.loadTextureInfoAsync(e,s,t))}_extensionsLoadTextureAsync(e,s,t){return this._applyExtensions(s,"loadTexture",n=>n._loadTextureAsync&&n._loadTextureAsync(e,s,t))}_extensionsLoadAnimationAsync(e,s){return this._applyExtensions(s,"loadAnimation",t=>t.loadAnimationAsync&&t.loadAnimationAsync(e,s))}_extensionsLoadAnimationChannelAsync(e,s,t,n,r){return this._applyExtensions(t,"loadAnimationChannel",o=>o._loadAnimationChannelAsync&&o._loadAnimationChannelAsync(e,s,t,n,r))}_extensionsLoadSkinAsync(e,s,t){return this._applyExtensions(t,"loadSkin",n=>n._loadSkinAsync&&n._loadSkinAsync(e,s,t))}_extensionsLoadUriAsync(e,s,t){return this._applyExtensions(s,"loadUri",n=>n._loadUriAsync&&n._loadUriAsync(e,s,t))}_extensionsLoadBufferViewAsync(e,s){return this._applyExtensions(s,"loadBufferView",t=>t.loadBufferViewAsync&&t.loadBufferViewAsync(e,s))}_extensionsLoadBufferAsync(e,s,t,n){return this._applyExtensions(s,"loadBuffer",r=>r.loadBufferAsync&&r.loadBufferAsync(e,s,t,n))}static LoadExtensionAsync(e,s,t,n){if(!s.extensions)return null;const o=s.extensions[t];return o?n(`${e}/extensions/${t}`,o):null}static LoadExtraAsync(e,s,t,n){if(!s.extras)return null;const o=s.extras[t];return o?n(`${e}/extras/${t}`,o):null}isExtensionUsed(e){return!!this._gltf.extensionsUsed&&this._gltf.extensionsUsed.indexOf(e)!==-1}logOpen(e){this._parent._logOpen(e)}logClose(){this._parent._logClose()}log(e){this._parent._log(e)}startPerformanceCounter(e){this._parent._startPerformanceCounter(e)}endPerformanceCounter(e){this._parent._endPerformanceCounter(e)}}_._RegisteredExtensions={};_.DefaultSampler={index:-1};$._CreateGLTF2Loader=i=>new _(i);const ve="EXT_lights_image_based";class Ft{constructor(e){this.name=ve,this._loader=e,this.enabled=this._loader.isExtensionUsed(ve)}dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const s=e[this.name];this._lights=s.lights}}loadSceneAsync(e,s){return _.LoadExtensionAsync(e,s,this.name,(t,n)=>{const r=new Array;r.push(this._loader.loadSceneAsync(e,s)),this._loader.logOpen(`${t}`);const o=p.Get(`${t}/light`,this._lights,n.light);return r.push(this._loadLightAsync(`/extensions/${this.name}/lights/${n.light}`,o).then(a=>{this._loader.babylonScene.environmentTexture=a})),this._loader.logClose(),Promise.all(r).then(()=>{})})}_loadLightAsync(e,s){if(!s._loaded){const t=new Array;this._loader.logOpen(`${e}`);const n=new Array(s.specularImages.length);for(let r=0;r<s.specularImages.length;r++){const o=s.specularImages[r];n[r]=new Array(o.length);for(let a=0;a<o.length;a++){const l=`${e}/specularImages/${r}/${a}`;this._loader.logOpen(`${l}`);const c=o[a],d=p.Get(l,this._loader.gltf.images,c);t.push(this._loader.loadImageAsync(`/images/${c}`,d).then(h=>{n[r][a]=h})),this._loader.logClose()}}this._loader.logClose(),s._loaded=Promise.all(t).then(()=>{const r=new hs(this._loader.babylonScene,null,s.specularImageSize);if(r.name=s.name||"environment",s._babylonTexture=r,s.intensity!=null&&(r.level=s.intensity),s.rotation){let c=J.FromArray(s.rotation);this._loader.babylonScene.useRightHandedSystem||(c=J.Inverse(c)),q.FromQuaternionToRef(c,r.getReflectionTextureMatrix())}if(!s.irradianceCoefficients)throw new Error(`${e}: Irradiance coefficients are missing`);const o=at.FromArray(s.irradianceCoefficients);o.scaleInPlace(s.intensity),o.convertIrradianceToLambertianRadiance();const a=lt.FromHarmonics(o),l=(n.length-1)/ct.Log2(s.specularImageSize);return r.updateRGBDAsync(n,a,l)})}return s._loaded.then(()=>s._babylonTexture)}}_.RegisterExtension(ve,i=>new Ft(i));const Le="EXT_mesh_gpu_instancing";class Vt{constructor(e){this.name=Le,this._loader=e,this.enabled=this._loader.isExtensionUsed(Le)}dispose(){this._loader=null}loadNodeAsync(e,s,t){return _.LoadExtensionAsync(e,s,this.name,(n,r)=>{this._loader._disableInstancedMesh++;const o=this._loader.loadNodeAsync(`/nodes/${s.index}`,s,t);if(this._loader._disableInstancedMesh--,!s._primitiveBabylonMeshes)return o;const a=new Array;let l=0;const c=d=>{if(r.attributes[d]==null){a.push(Promise.resolve(null));return}const h=p.Get(`${n}/attributes/${d}`,this._loader.gltf.accessors,r.attributes[d]);if(a.push(this._loader._loadFloatAccessorAsync(`/accessors/${h.bufferView}`,h)),l===0)l=h.count;else if(l!==h.count)throw new Error(`${n}/attributes: Instance buffer accessors do not have the same count.`)};return c("TRANSLATION"),c("ROTATION"),c("SCALE"),o.then(d=>Promise.all(a).then(([h,u,f])=>{const m=new Float32Array(l*16);X.Vector3[0].copyFromFloats(0,0,0),X.Quaternion[0].copyFromFloats(0,0,0,1),X.Vector3[1].copyFromFloats(1,1,1);for(let g=0;g<l;++g)h&&T.FromArrayToRef(h,g*3,X.Vector3[0]),u&&J.FromArrayToRef(u,g*4,X.Quaternion[0]),f&&T.FromArrayToRef(f,g*3,X.Vector3[1]),q.ComposeToRef(X.Vector3[1],X.Quaternion[0],X.Vector3[0],X.Matrix[0]),X.Matrix[0].copyToArray(m,g*16);for(const g of s._primitiveBabylonMeshes)g.thinInstanceSetBuffer("matrix",m,16,!0);return d}))})}}_.RegisterExtension(Le,i=>new Vt(i));const Pe="EXT_meshopt_compression";class kt{constructor(e){this.name=Pe,this.enabled=e.isExtensionUsed(Pe),this._loader=e}dispose(){this._loader=null}loadBufferViewAsync(e,s){return _.LoadExtensionAsync(e,s,this.name,(t,n)=>{const r=s;if(r._meshOptData)return r._meshOptData;const o=p.Get(`${e}/buffer`,this._loader.gltf.buffers,n.buffer);return r._meshOptData=this._loader.loadBufferAsync(`/buffers/${o.index}`,o,n.byteOffset||0,n.byteLength).then(a=>dt.Default.decodeGltfBufferAsync(a,n.count,n.byteStride,n.mode,n.filter)),r._meshOptData})}}_.RegisterExtension(Pe,i=>new kt(i));const $e="EXT_texture_webp";class Ut{constructor(e){this.name=$e,this._loader=e,this.enabled=e.isExtensionUsed($e)}dispose(){this._loader=null}_loadTextureAsync(e,s,t){return _.LoadExtensionAsync(e,s,this.name,(n,r)=>{const o=s.sampler==null?_.DefaultSampler:p.Get(`${e}/sampler`,this._loader.gltf.samplers,s.sampler),a=p.Get(`${n}/source`,this._loader.gltf.images,r.source);return this._loader._createTextureAsync(e,o,a,l=>{t(l)},void 0,!s._textureInfo.nonColorData)})}}_.RegisterExtension($e,i=>new Ut(i));const Re="KHR_draco_mesh_compression";class Gt{constructor(e){this.name=Re,this._loader=e,this.enabled=As.DecoderAvailable&&this._loader.isExtensionUsed(Re)}dispose(){delete this.dracoCompression,this._loader=null}_loadVertexDataAsync(e,s,t){return _.LoadExtensionAsync(e,s,this.name,(n,r)=>{if(s.mode!=null){if(s.mode!==5&&s.mode!==4)throw new Error(`${e}: Unsupported mode ${s.mode}`);if(s.mode===5)throw new Error(`${e}: Mode ${s.mode} is not currently supported`)}const o={},a={},l=(d,h)=>{const u=r.attributes[d];if(u===void 0||s.attributes[d]===void 0)return;o[h]=u;const f=p.Get(`${e}/attributes/${d}`,this._loader.gltf.accessors,s.attributes[d]);if(f.normalized&&f.componentType!==5126){let m=1;switch(f.componentType){case 5120:m=127;break;case 5121:m=255;break;case 5122:m=32767;break;case 5123:m=65535;break}a[h]=m}t._delayInfo=t._delayInfo||[],t._delayInfo.indexOf(h)===-1&&t._delayInfo.push(h)};l("POSITION",x.PositionKind),l("NORMAL",x.NormalKind),l("TANGENT",x.TangentKind),l("TEXCOORD_0",x.UVKind),l("TEXCOORD_1",x.UV2Kind),l("TEXCOORD_2",x.UV3Kind),l("TEXCOORD_3",x.UV4Kind),l("TEXCOORD_4",x.UV5Kind),l("TEXCOORD_5",x.UV6Kind),l("JOINTS_0",x.MatricesIndicesKind),l("WEIGHTS_0",x.MatricesWeightsKind),l("COLOR_0",x.ColorKind);const c=p.Get(n,this._loader.gltf.bufferViews,r.bufferView);return c._dracoBabylonGeometry||(c._dracoBabylonGeometry=this._loader.loadBufferViewAsync(`/bufferViews/${c.index}`,c).then(d=>(this.dracoCompression||As.Default).decodeMeshAsync(d,o,a).then(u=>{const f=new cs(t.name,this._loader.babylonScene);return u.applyToGeometry(f),f}).catch(u=>{throw new Error(`${e}: ${u.message}`)}))),c._dracoBabylonGeometry})}}_.RegisterExtension(Re,i=>new Gt(i));const De="KHR_lights_punctual";class Ht{constructor(e){this.name=De,this._loader=e,this.enabled=this._loader.isExtensionUsed(De)}dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const s=e[this.name];this._lights=s.lights,p.Assign(this._lights)}}loadNodeAsync(e,s,t){return _.LoadExtensionAsync(e,s,this.name,(n,r)=>this._loader.loadNodeAsync(e,s,o=>{let a;const l=p.Get(n,this._lights,r.light),c=l.name||o.name;switch(this._loader.babylonScene._blockEntityCollection=!!this._loader._assetContainer,l.type){case"directional":{a=new is(c,T.Backward(),this._loader.babylonScene);break}case"point":{a=new as(c,T.Zero(),this._loader.babylonScene);break}case"spot":{const d=new ls(c,T.Zero(),T.Backward(),0,1,this._loader.babylonScene);d.angle=(l.spot&&l.spot.outerConeAngle||Math.PI/4)*2,d.innerAngle=(l.spot&&l.spot.innerConeAngle||0)*2,a=d;break}default:throw this._loader.babylonScene._blockEntityCollection=!1,new Error(`${n}: Invalid light type (${l.type})`)}a._parentContainer=this._loader._assetContainer,this._loader.babylonScene._blockEntityCollection=!1,l._babylonLight=a,a.falloffType=ht.FALLOFF_GLTF,a.diffuse=l.color?L.FromArray(l.color):L.White(),a.intensity=l.intensity==null?1:l.intensity,a.range=l.range==null?Number.MAX_VALUE:l.range,a.parent=o,this._loader._babylonLights.push(a),_.AddPointerMetadata(a,n),t(o)}))}}_.RegisterExtension(De,i=>new Ht(i));const Be="KHR_materials_pbrSpecularGlossiness";class Kt{constructor(e){this.name=Be,this.order=200,this._loader=e,this.enabled=this._loader.isExtensionUsed(Be)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,s,t){return _.LoadExtensionAsync(e,s,this.name,(n,r)=>{const o=new Array;return o.push(this._loader.loadMaterialBasePropertiesAsync(e,s,t)),o.push(this._loadSpecularGlossinessPropertiesAsync(n,s,r,t)),this._loader.loadMaterialAlphaProperties(e,s,t),Promise.all(o).then(()=>{})})}_loadSpecularGlossinessPropertiesAsync(e,s,t,n){if(!(n instanceof V))throw new Error(`${e}: Material type not supported`);const r=new Array;return n.metallic=null,n.roughness=null,t.diffuseFactor?(n.albedoColor=L.FromArray(t.diffuseFactor),n.alpha=t.diffuseFactor[3]):n.albedoColor=L.White(),n.reflectivityColor=t.specularFactor?L.FromArray(t.specularFactor):L.White(),n.microSurface=t.glossinessFactor==null?1:t.glossinessFactor,t.diffuseTexture&&r.push(this._loader.loadTextureInfoAsync(`${e}/diffuseTexture`,t.diffuseTexture,o=>{o.name=`${n.name} (Diffuse)`,n.albedoTexture=o})),t.specularGlossinessTexture&&(r.push(this._loader.loadTextureInfoAsync(`${e}/specularGlossinessTexture`,t.specularGlossinessTexture,o=>{o.name=`${n.name} (Specular Glossiness)`,n.reflectivityTexture=o,n.reflectivityTexture.hasAlpha=!0})),n.useMicroSurfaceFromReflectivityMapAlpha=!0),Promise.all(r).then(()=>{})}}_.RegisterExtension(Be,i=>new Kt(i));const Fe="KHR_materials_unlit";class Wt{constructor(e){this.name=Fe,this.order=210,this._loader=e,this.enabled=this._loader.isExtensionUsed(Fe)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,s,t){return _.LoadExtensionAsync(e,s,this.name,()=>this._loadUnlitPropertiesAsync(e,s,t))}_loadUnlitPropertiesAsync(e,s,t){if(!(t instanceof V))throw new Error(`${e}: Material type not supported`);const n=new Array;t.unlit=!0;const r=s.pbrMetallicRoughness;return r&&(r.baseColorFactor?(t.albedoColor=L.FromArray(r.baseColorFactor),t.alpha=r.baseColorFactor[3]):t.albedoColor=L.White(),r.baseColorTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/baseColorTexture`,r.baseColorTexture,o=>{o.name=`${t.name} (Base Color)`,t.albedoTexture=o}))),s.doubleSided&&(t.backFaceCulling=!1,t.twoSidedLighting=!0),this._loader.loadMaterialAlphaProperties(e,s,t),Promise.all(n).then(()=>{})}}_.RegisterExtension(Fe,i=>new Wt(i));const Ve="KHR_materials_clearcoat";class jt{constructor(e){this.name=Ve,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ve)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,s,t){return _.LoadExtensionAsync(e,s,this.name,(n,r)=>{const o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,s,t)),o.push(this._loadClearCoatPropertiesAsync(n,r,t)),Promise.all(o).then(()=>{})})}_loadClearCoatPropertiesAsync(e,s,t){if(!(t instanceof V))throw new Error(`${e}: Material type not supported`);const n=new Array;return t.clearCoat.isEnabled=!0,t.clearCoat.useRoughnessFromMainTexture=!1,t.clearCoat.remapF0OnInterfaceChange=!1,s.clearcoatFactor!=null?t.clearCoat.intensity=s.clearcoatFactor:t.clearCoat.intensity=0,s.clearcoatTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatTexture`,s.clearcoatTexture,r=>{r.name=`${t.name} (ClearCoat Intensity)`,t.clearCoat.texture=r})),s.clearcoatRoughnessFactor!=null?t.clearCoat.roughness=s.clearcoatRoughnessFactor:t.clearCoat.roughness=0,s.clearcoatRoughnessTexture&&(s.clearcoatRoughnessTexture.nonColorData=!0,n.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatRoughnessTexture`,s.clearcoatRoughnessTexture,r=>{r.name=`${t.name} (ClearCoat Roughness)`,t.clearCoat.textureRoughness=r}))),s.clearcoatNormalTexture&&(s.clearcoatNormalTexture.nonColorData=!0,n.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatNormalTexture`,s.clearcoatNormalTexture,r=>{r.name=`${t.name} (ClearCoat Normal)`,t.clearCoat.bumpTexture=r})),t.invertNormalMapX=!t.getScene().useRightHandedSystem,t.invertNormalMapY=t.getScene().useRightHandedSystem,s.clearcoatNormalTexture.scale!=null&&(t.clearCoat.bumpTexture.level=s.clearcoatNormalTexture.scale)),Promise.all(n).then(()=>{})}}_.RegisterExtension(Ve,i=>new jt(i));const ke="KHR_materials_iridescence";class Yt{constructor(e){this.name=ke,this.order=195,this._loader=e,this.enabled=this._loader.isExtensionUsed(ke)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,s,t){return _.LoadExtensionAsync(e,s,this.name,(n,r)=>{const o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,s,t)),o.push(this._loadIridescencePropertiesAsync(n,r,t)),Promise.all(o).then(()=>{})})}_loadIridescencePropertiesAsync(e,s,t){var n,r,o,a,l;if(!(t instanceof V))throw new Error(`${e}: Material type not supported`);const c=new Array;return t.iridescence.isEnabled=!0,t.iridescence.intensity=(n=s.iridescenceFactor)!==null&&n!==void 0?n:0,t.iridescence.indexOfRefraction=(o=(r=s.iridescenceIor)!==null&&r!==void 0?r:s.iridescenceIOR)!==null&&o!==void 0?o:1.3,t.iridescence.minimumThickness=(a=s.iridescenceThicknessMinimum)!==null&&a!==void 0?a:100,t.iridescence.maximumThickness=(l=s.iridescenceThicknessMaximum)!==null&&l!==void 0?l:400,s.iridescenceTexture&&c.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceTexture`,s.iridescenceTexture,d=>{d.name=`${t.name} (Iridescence Intensity)`,t.iridescence.texture=d})),s.iridescenceThicknessTexture&&c.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceThicknessTexture`,s.iridescenceThicknessTexture,d=>{d.name=`${t.name} (Iridescence Thickness)`,t.iridescence.thicknessTexture=d})),Promise.all(c).then(()=>{})}}_.RegisterExtension(ke,i=>new Yt(i));const Ue="KHR_materials_emissive_strength";class qt{constructor(e){this.name=Ue,this.order=170,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ue)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,s,t){return _.LoadExtensionAsync(e,s,this.name,(n,r)=>this._loader.loadMaterialPropertiesAsync(e,s,t).then(()=>{this._loadEmissiveProperties(n,r,t)}))}_loadEmissiveProperties(e,s,t){if(!(t instanceof V))throw new Error(`${e}: Material type not supported`);s.emissiveStrength!==void 0&&t.emissiveColor.scaleToRef(s.emissiveStrength,t.emissiveColor)}}_.RegisterExtension(Ue,i=>new qt(i));const Ge="KHR_materials_sheen";class Jt{constructor(e){this.name=Ge,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ge)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,s,t){return _.LoadExtensionAsync(e,s,this.name,(n,r)=>{const o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,s,t)),o.push(this._loadSheenPropertiesAsync(n,r,t)),Promise.all(o).then(()=>{})})}_loadSheenPropertiesAsync(e,s,t){if(!(t instanceof V))throw new Error(`${e}: Material type not supported`);const n=new Array;return t.sheen.isEnabled=!0,t.sheen.intensity=1,s.sheenColorFactor!=null?t.sheen.color=L.FromArray(s.sheenColorFactor):t.sheen.color=L.Black(),s.sheenColorTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/sheenColorTexture`,s.sheenColorTexture,r=>{r.name=`${t.name} (Sheen Color)`,t.sheen.texture=r})),s.sheenRoughnessFactor!==void 0?t.sheen.roughness=s.sheenRoughnessFactor:t.sheen.roughness=0,s.sheenRoughnessTexture&&(s.sheenRoughnessTexture.nonColorData=!0,n.push(this._loader.loadTextureInfoAsync(`${e}/sheenRoughnessTexture`,s.sheenRoughnessTexture,r=>{r.name=`${t.name} (Sheen Roughness)`,t.sheen.textureRoughness=r}))),t.sheen.albedoScaling=!0,t.sheen.useRoughnessFromMainTexture=!1,Promise.all(n).then(()=>{})}}_.RegisterExtension(Ge,i=>new Jt(i));const He="KHR_materials_specular";class zt{constructor(e){this.name=He,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(He)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,s,t){return _.LoadExtensionAsync(e,s,this.name,(n,r)=>{const o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,s,t)),o.push(this._loadSpecularPropertiesAsync(n,r,t)),Promise.all(o).then(()=>{})})}_loadSpecularPropertiesAsync(e,s,t){if(!(t instanceof V))throw new Error(`${e}: Material type not supported`);const n=new Array;return s.specularFactor!==void 0&&(t.metallicF0Factor=s.specularFactor),s.specularColorFactor!==void 0&&(t.metallicReflectanceColor=L.FromArray(s.specularColorFactor)),s.specularTexture&&(s.specularTexture.nonColorData=!0,n.push(this._loader.loadTextureInfoAsync(`${e}/specularTexture`,s.specularTexture,r=>{r.name=`${t.name} (Specular F0 Strength)`,t.metallicReflectanceTexture=r,t.useOnlyMetallicFromMetallicReflectanceTexture=!0}))),s.specularColorTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/specularColorTexture`,s.specularColorTexture,r=>{r.name=`${t.name} (Specular F0 Color)`,t.reflectanceTexture=r})),Promise.all(n).then(()=>{})}}_.RegisterExtension(He,i=>new zt(i));const Ke="KHR_materials_ior";class be{constructor(e){this.name=Ke,this.order=180,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ke)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,s,t){return _.LoadExtensionAsync(e,s,this.name,(n,r)=>{const o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,s,t)),o.push(this._loadIorPropertiesAsync(n,r,t)),Promise.all(o).then(()=>{})})}_loadIorPropertiesAsync(e,s,t){if(!(t instanceof V))throw new Error(`${e}: Material type not supported`);return s.ior!==void 0?t.indexOfRefraction=s.ior:t.indexOfRefraction=be._DEFAULT_IOR,Promise.resolve()}}be._DEFAULT_IOR=1.5;_.RegisterExtension(Ke,i=>new be(i));const j="KHR_materials_variants";class te{constructor(e){this.name=j,this._loader=e,this.enabled=this._loader.isExtensionUsed(j)}dispose(){this._loader=null}static GetAvailableVariants(e){const s=this._GetExtensionMetadata(e);return s?Object.keys(s.variants):[]}getAvailableVariants(e){return te.GetAvailableVariants(e)}static SelectVariant(e,s){const t=this._GetExtensionMetadata(e);if(!t)throw new Error(`Cannot select variant on a glTF mesh that does not have the ${j} extension`);const n=r=>{const o=t.variants[r];if(o)for(const a of o)a.mesh.material=a.material};if(s instanceof Array)for(const r of s)n(r);else n(s);t.lastSelected=s}selectVariant(e,s){return te.SelectVariant(e,s)}static Reset(e){const s=this._GetExtensionMetadata(e);if(!s)throw new Error(`Cannot reset on a glTF mesh that does not have the ${j} extension`);for(const t of s.original)t.mesh.material=t.material;s.lastSelected=null}reset(e){return te.Reset(e)}static GetLastSelectedVariant(e){const s=this._GetExtensionMetadata(e);if(!s)throw new Error(`Cannot get the last selected variant on a glTF mesh that does not have the ${j} extension`);return s.lastSelected}getLastSelectedVariant(e){return te.GetLastSelectedVariant(e)}static _GetExtensionMetadata(e){var s,t;return((t=(s=e?._internalMetadata)===null||s===void 0?void 0:s.gltf)===null||t===void 0?void 0:t[j])||null}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const s=e[this.name];this._variants=s.variants}}_loadMeshPrimitiveAsync(e,s,t,n,r,o){return _.LoadExtensionAsync(e,r,this.name,(a,l)=>{const c=new Array;return c.push(this._loader._loadMeshPrimitiveAsync(e,s,t,n,r,d=>{if(o(d),d instanceof ce){const h=_._GetDrawMode(e,r.mode),u=this._loader.rootBabylonMesh,f=u?u._internalMetadata=u._internalMetadata||{}:{},m=f.gltf=f.gltf||{},g=m[j]=m[j]||{lastSelected:null,original:[],variants:{}};g.original.push({mesh:d,material:d.material});for(let E=0;E<l.mappings.length;++E){const A=l.mappings[E],C=p.Get(`${a}/mappings/${E}/material`,this._loader.gltf.materials,A.material);c.push(this._loader._loadMaterialAsync(`#/materials/${A.material}`,C,d,h,I=>{for(let M=0;M<A.variants.length;++M){const O=A.variants[M],w=p.Get(`/extensions/${j}/variants/${O}`,this._variants,O);g.variants[w.name]=g.variants[w.name]||[],g.variants[w.name].push({mesh:d,material:I}),d.onClonedObservable.add(b=>{const S=b;let B=null,F=S;do{if(F=F.parent,!F)return;B=te._GetExtensionMetadata(F)}while(B===null);if(u&&B===te._GetExtensionMetadata(u)){F._internalMetadata={};for(const k in u._internalMetadata)F._internalMetadata[k]=u._internalMetadata[k];F._internalMetadata.gltf=[];for(const k in u._internalMetadata.gltf)F._internalMetadata.gltf[k]=u._internalMetadata.gltf[k];F._internalMetadata.gltf[j]={lastSelected:null,original:[],variants:{}};for(const k of B.original)F._internalMetadata.gltf[j].original.push({mesh:k.mesh,material:k.material});for(const k in B.variants)if(Object.prototype.hasOwnProperty.call(B.variants,k)){F._internalMetadata.gltf[j].variants[k]=[];for(const _s of B.variants[k])F._internalMetadata.gltf[j].variants[k].push({mesh:_s.mesh,material:_s.material})}B=F._internalMetadata.gltf[j]}for(const k of B.original)k.mesh===d&&(k.mesh=S);for(const k of B.variants[w.name])k.mesh===d&&(k.mesh=S)})}}))}}})),Promise.all(c).then(([d])=>d)})}}_.RegisterExtension(j,i=>new te(i));class fs{static _GetDefaultOptions(){return{renderSize:1024,samples:4,lodGenerationScale:1,lodGenerationOffset:-4,renderTargetTextureType:oe.TEXTURETYPE_HALF_FLOAT,generateMipmaps:!0}}constructor(e,s){this._opaqueRenderTarget=null,this._opaqueMeshesCache=[],this._transparentMeshesCache=[],this._materialObservers={},this._options={...fs._GetDefaultOptions(),...e},this._scene=s,this._scene._transmissionHelper=this,this.onErrorObservable=new W,this._scene.onDisposeObservable.addOnce(()=>{this.dispose()}),this._parseScene(),this._setupRenderTargets()}updateOptions(e){if(!Object.keys(e).filter(r=>this._options[r]!==e[r]).length)return;const t={...this._options,...e},n=this._options;this._options=t,t.renderSize!==n.renderSize||t.renderTargetTextureType!==n.renderTargetTextureType||t.generateMipmaps!==n.generateMipmaps||!this._opaqueRenderTarget?this._setupRenderTargets():(this._opaqueRenderTarget.samples=t.samples,this._opaqueRenderTarget.lodGenerationScale=t.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=t.lodGenerationOffset)}getOpaqueTarget(){return this._opaqueRenderTarget}_shouldRenderAsTransmission(e){return e?!!(e instanceof V&&e.subSurface.isRefractionEnabled):!1}_addMesh(e){this._materialObservers[e.uniqueId]=e.onMaterialChangedObservable.add(this._onMeshMaterialChanged.bind(this)),N.SetImmediate(()=>{this._shouldRenderAsTransmission(e.material)?(e.material.refractionTexture=this._opaqueRenderTarget,this._transparentMeshesCache.indexOf(e)===-1&&this._transparentMeshesCache.push(e)):this._opaqueMeshesCache.indexOf(e)===-1&&this._opaqueMeshesCache.push(e)})}_removeMesh(e){e.onMaterialChangedObservable.remove(this._materialObservers[e.uniqueId]),delete this._materialObservers[e.uniqueId];let s=this._transparentMeshesCache.indexOf(e);s!==-1&&this._transparentMeshesCache.splice(s,1),s=this._opaqueMeshesCache.indexOf(e),s!==-1&&this._opaqueMeshesCache.splice(s,1)}_parseScene(){this._scene.meshes.forEach(this._addMesh.bind(this)),this._scene.onNewMeshAddedObservable.add(this._addMesh.bind(this)),this._scene.onMeshRemovedObservable.add(this._removeMesh.bind(this))}_onMeshMaterialChanged(e){const s=this._transparentMeshesCache.indexOf(e),t=this._opaqueMeshesCache.indexOf(e);this._shouldRenderAsTransmission(e.material)?(e.material instanceof V&&(e.material.subSurface.refractionTexture=this._opaqueRenderTarget),t!==-1?(this._opaqueMeshesCache.splice(t,1),this._transparentMeshesCache.push(e)):s===-1&&this._transparentMeshesCache.push(e)):s!==-1?(this._transparentMeshesCache.splice(s,1),this._opaqueMeshesCache.push(e)):t===-1&&this._opaqueMeshesCache.push(e)}_setupRenderTargets(){var e,s;this._opaqueRenderTarget&&this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=new ut("opaqueSceneTexture",this._options.renderSize,this._scene,this._options.generateMipmaps,void 0,this._options.renderTargetTextureType),this._opaqueRenderTarget.ignoreCameraViewport=!0,this._opaqueRenderTarget.renderList=this._opaqueMeshesCache,this._opaqueRenderTarget.clearColor=(s=(e=this._options.clearColor)===null||e===void 0?void 0:e.clone())!==null&&s!==void 0?s:this._scene.clearColor.clone(),this._opaqueRenderTarget.gammaSpace=!1,this._opaqueRenderTarget.lodGenerationScale=this._options.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=this._options.lodGenerationOffset,this._opaqueRenderTarget.samples=this._options.samples;let t,n;this._opaqueRenderTarget.onBeforeBindObservable.add(r=>{n=this._scene.environmentIntensity,this._scene.environmentIntensity=1,t=this._scene.imageProcessingConfiguration.applyByPostProcess,this._options.clearColor?r.clearColor.copyFrom(this._options.clearColor):this._scene.clearColor.toLinearSpaceToRef(r.clearColor,this._scene.getEngine().useExactSrgbConversions),this._scene.imageProcessingConfiguration._applyByPostProcess=!0}),this._opaqueRenderTarget.onAfterUnbindObservable.add(()=>{this._scene.environmentIntensity=n,this._scene.imageProcessingConfiguration._applyByPostProcess=t}),this._transparentMeshesCache.forEach(r=>{this._shouldRenderAsTransmission(r.material)&&(r.material.refractionTexture=this._opaqueRenderTarget)})}dispose(){this._scene._transmissionHelper=void 0,this._opaqueRenderTarget&&(this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=null),this._transparentMeshesCache=[],this._opaqueMeshesCache=[]}}const We="KHR_materials_transmission";class Xt{constructor(e){this.name=We,this.order=175,this._loader=e,this.enabled=this._loader.isExtensionUsed(We),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,s,t){return _.LoadExtensionAsync(e,s,this.name,(n,r)=>{const o=new Array;return o.push(this._loader.loadMaterialBasePropertiesAsync(e,s,t)),o.push(this._loader.loadMaterialPropertiesAsync(e,s,t)),o.push(this._loadTransparentPropertiesAsync(n,s,t,r)),Promise.all(o).then(()=>{})})}_loadTransparentPropertiesAsync(e,s,t,n){if(!(t instanceof V))throw new Error(`${e}: Material type not supported`);const r=t;if(r.subSurface.isRefractionEnabled=!0,r.subSurface.volumeIndexOfRefraction=1,r.subSurface.useAlbedoToTintRefraction=!0,n.transmissionFactor!==void 0){r.subSurface.refractionIntensity=n.transmissionFactor;const o=r.getScene();r.subSurface.refractionIntensity&&!o._transmissionHelper&&new fs({},r.getScene())}else return r.subSurface.refractionIntensity=0,r.subSurface.isRefractionEnabled=!1,Promise.resolve();return r.subSurface.minimumThickness=0,r.subSurface.maximumThickness=0,n.transmissionTexture?(n.transmissionTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/transmissionTexture`,n.transmissionTexture,void 0).then(o=>{r.subSurface.refractionIntensityTexture=o,r.subSurface.useGltfStyleTextures=!0})):Promise.resolve()}}_.RegisterExtension(We,i=>new Xt(i));const je="KHR_materials_translucency";class Zt{constructor(e){this.name=je,this.order=174,this._loader=e,this.enabled=this._loader.isExtensionUsed(je),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,s,t){return _.LoadExtensionAsync(e,s,this.name,(n,r)=>{const o=new Array;return o.push(this._loader.loadMaterialBasePropertiesAsync(e,s,t)),o.push(this._loader.loadMaterialPropertiesAsync(e,s,t)),o.push(this._loadTranslucentPropertiesAsync(n,s,t,r)),Promise.all(o).then(()=>{})})}_loadTranslucentPropertiesAsync(e,s,t,n){if(!(t instanceof V))throw new Error(`${e}: Material type not supported`);const r=t;if(r.subSurface.isTranslucencyEnabled=!0,r.subSurface.volumeIndexOfRefraction=1,r.subSurface.minimumThickness=0,r.subSurface.maximumThickness=0,r.subSurface.useAlbedoToTintTranslucency=!0,n.translucencyFactor!==void 0)r.subSurface.translucencyIntensity=n.translucencyFactor;else return r.subSurface.translucencyIntensity=0,r.subSurface.isTranslucencyEnabled=!1,Promise.resolve();return n.translucencyTexture?(n.translucencyTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/translucencyTexture`,n.translucencyTexture).then(o=>{r.subSurface.translucencyIntensityTexture=o})):Promise.resolve()}}_.RegisterExtension(je,i=>new Zt(i));const Ye="KHR_materials_volume";class Qt{constructor(e){this.name=Ye,this.order=173,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ye),this.enabled&&this._loader._disableInstancedMesh++}dispose(){this.enabled&&this._loader._disableInstancedMesh--,this._loader=null}loadMaterialPropertiesAsync(e,s,t){return _.LoadExtensionAsync(e,s,this.name,(n,r)=>{const o=new Array;return o.push(this._loader.loadMaterialBasePropertiesAsync(e,s,t)),o.push(this._loader.loadMaterialPropertiesAsync(e,s,t)),o.push(this._loadVolumePropertiesAsync(n,s,t,r)),Promise.all(o).then(()=>{})})}_loadVolumePropertiesAsync(e,s,t,n){if(!(t instanceof V))throw new Error(`${e}: Material type not supported`);if(!t.subSurface.isRefractionEnabled&&!t.subSurface.isTranslucencyEnabled||!n.thicknessFactor)return Promise.resolve();t.subSurface.volumeIndexOfRefraction=t.indexOfRefraction;const r=n.attenuationDistance!==void 0?n.attenuationDistance:Number.MAX_VALUE;return t.subSurface.tintColorAtDistance=r,n.attenuationColor!==void 0&&n.attenuationColor.length==3&&t.subSurface.tintColor.copyFromFloats(n.attenuationColor[0],n.attenuationColor[1],n.attenuationColor[2]),t.subSurface.minimumThickness=0,t.subSurface.maximumThickness=n.thicknessFactor,t.subSurface.useThicknessAsDepth=!0,n.thicknessTexture?(n.thicknessTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/thicknessTexture`,n.thicknessTexture).then(o=>{t.subSurface.thicknessTexture=o,t.subSurface.useGltfStyleTextures=!0})):Promise.resolve()}}_.RegisterExtension(Ye,i=>new Qt(i));const qe="KHR_mesh_quantization";class en{constructor(e){this.name=qe,this.enabled=e.isExtensionUsed(qe)}dispose(){}}_.RegisterExtension(qe,i=>new en(i));const Je="KHR_texture_basisu";class sn{constructor(e){this.name=Je,this._loader=e,this.enabled=e.isExtensionUsed(Je)}dispose(){this._loader=null}_loadTextureAsync(e,s,t){return _.LoadExtensionAsync(e,s,this.name,(n,r)=>{const o=s.sampler==null?_.DefaultSampler:p.Get(`${e}/sampler`,this._loader.gltf.samplers,s.sampler),a=p.Get(`${n}/source`,this._loader.gltf.images,r.source);return this._loader._createTextureAsync(e,o,a,l=>{t(l)},s._textureInfo.nonColorData?{useRGBAIfASTCBC7NotAvailableWhenUASTC:!0}:void 0,!s._textureInfo.nonColorData)})}}_.RegisterExtension(Je,i=>new sn(i));const ze="KHR_texture_transform";class tn{constructor(e){this.name=ze,this._loader=e,this.enabled=this._loader.isExtensionUsed(ze)}dispose(){this._loader=null}loadTextureInfoAsync(e,s,t){return _.LoadExtensionAsync(e,s,this.name,(n,r)=>this._loader.loadTextureInfoAsync(e,s,o=>{if(!(o instanceof v))throw new Error(`${n}: Texture type not supported`);r.offset&&(o.uOffset=r.offset[0],o.vOffset=r.offset[1]),o.uRotationCenter=0,o.vRotationCenter=0,r.rotation&&(o.wAng=-r.rotation),r.scale&&(o.uScale=r.scale[0],o.vScale=r.scale[1]),r.texCoord!=null&&(o.coordinatesIndex=r.texCoord),t(o)}))}}_.RegisterExtension(ze,i=>new tn(i));const Xe="KHR_xmp_json_ld";class nn{constructor(e){this.name=Xe,this.order=100,this._loader=e,this.enabled=this._loader.isExtensionUsed(Xe)}dispose(){this._loader=null}onLoading(){var e,s,t;if(this._loader.rootBabylonMesh===null)return;const n=(e=this._loader.gltf.extensions)===null||e===void 0?void 0:e.KHR_xmp_json_ld,r=(t=(s=this._loader.gltf.asset)===null||s===void 0?void 0:s.extensions)===null||t===void 0?void 0:t.KHR_xmp_json_ld;if(n&&r){const o=+r.packet;n.packets&&o<n.packets.length&&(this._loader.rootBabylonMesh.metadata=this._loader.rootBabylonMesh.metadata||{},this._loader.rootBabylonMesh.metadata.xmp=n.packets[o])}}}_.RegisterExtension(Xe,i=>new nn(i));function ae(i,e,s,t){return L.FromArray(e,s).scale(t)}function rn(i,e,s,t){return e[s+3]*t}function D(i,e,s,t){return e[s]*t}function Ze(i,e,s,t){return-e[s]*t}function ye(i,e,s,t){return e[s+1]*t}function Ss(i,e,s,t){return e[s]*t*2}function xe(i){return{scale:[new P(y.ANIMATIONTYPE_FLOAT,`${i}.uScale`,D,()=>2),new P(y.ANIMATIONTYPE_FLOAT,`${i}.vScale`,ye,()=>2)],offset:[new P(y.ANIMATIONTYPE_FLOAT,`${i}.uOffset`,D,()=>2),new P(y.ANIMATIONTYPE_FLOAT,`${i}.vOffset`,ye,()=>2)],rotation:[new P(y.ANIMATIONTYPE_FLOAT,`${i}.wAng`,Ze,()=>1)]}}class ee extends ge{buildAnimations(e,s,t,n,r){r(e._babylonCamera,this._buildAnimation(s,t,n))}}class P extends ge{buildAnimations(e,s,t,n,r){for(const o in e._data)r(e._data[o].babylonMaterial,this._buildAnimation(s,t,n))}}class he extends ge{buildAnimations(e,s,t,n,r){r(e._babylonLight,this._buildAnimation(s,t,n))}}const on={__array__:{__target__:!0,...fe}},an={__array__:{__target__:!0,orthographic:{xmag:[new ee(y.ANIMATIONTYPE_FLOAT,"orthoLeft",Ze,()=>1),new ee(y.ANIMATIONTYPE_FLOAT,"orthoRight",ye,()=>1)],ymag:[new ee(y.ANIMATIONTYPE_FLOAT,"orthoBottom",Ze,()=>1),new ee(y.ANIMATIONTYPE_FLOAT,"orthoTop",ye,()=>1)],zfar:[new ee(y.ANIMATIONTYPE_FLOAT,"maxZ",D,()=>1)],znear:[new ee(y.ANIMATIONTYPE_FLOAT,"minZ",D,()=>1)]},perspective:{yfov:[new ee(y.ANIMATIONTYPE_FLOAT,"fov",D,()=>1)],zfar:[new ee(y.ANIMATIONTYPE_FLOAT,"maxZ",D,()=>1)],znear:[new ee(y.ANIMATIONTYPE_FLOAT,"minZ",D,()=>1)]}}},ln={__array__:{__target__:!0,pbrMetallicRoughness:{baseColorFactor:[new P(y.ANIMATIONTYPE_COLOR3,"albedoColor",ae,()=>4),new P(y.ANIMATIONTYPE_FLOAT,"alpha",rn,()=>4)],metallicFactor:[new P(y.ANIMATIONTYPE_FLOAT,"metallic",D,()=>1)],roughnessFactor:[new P(y.ANIMATIONTYPE_FLOAT,"roughness",D,()=>1)],baseColorTexture:{extensions:{KHR_texture_transform:xe("albedoTexture")}}},emissiveFactor:[new P(y.ANIMATIONTYPE_COLOR3,"emissiveColor",ae,()=>3)],normalTexture:{scale:[new P(y.ANIMATIONTYPE_FLOAT,"bumpTexture.level",D,()=>1)]},occlusionTexture:{strength:[new P(y.ANIMATIONTYPE_FLOAT,"ambientTextureStrength",D,()=>1)],extensions:{KHR_texture_transform:xe("ambientTexture")}},emissiveTexture:{extensions:{KHR_texture_transform:xe("emissiveTexture")}},extensions:{KHR_materials_ior:{ior:[new P(y.ANIMATIONTYPE_FLOAT,"indexOfRefraction",D,()=>1)]},KHR_materials_clearcoat:{clearcoatFactor:[new P(y.ANIMATIONTYPE_FLOAT,"clearCoat.intensity",D,()=>1)],clearcoatRoughnessFactor:[new P(y.ANIMATIONTYPE_FLOAT,"clearCoat.roughness",D,()=>1)]},KHR_materials_sheen:{sheenColorFactor:[new P(y.ANIMATIONTYPE_COLOR3,"sheen.color",ae,()=>3)],sheenRoughnessFactor:[new P(y.ANIMATIONTYPE_FLOAT,"sheen.roughness",D,()=>1)]},KHR_materials_specular:{specularFactor:[new P(y.ANIMATIONTYPE_FLOAT,"metallicF0Factor",D,()=>1)],specularColorFactor:[new P(y.ANIMATIONTYPE_COLOR3,"metallicReflectanceColor",ae,()=>3)]},KHR_materials_emissive_strength:{emissiveStrength:[new P(y.ANIMATIONTYPE_FLOAT,"emissiveIntensity",D,()=>1)]},KHR_materials_transmission:{transmissionFactor:[new P(y.ANIMATIONTYPE_FLOAT,"subSurface.refractionIntensity",D,()=>1)]},KHR_materials_volume:{attenuationColor:[new P(y.ANIMATIONTYPE_COLOR3,"subSurface.tintColor",ae,()=>3)],attenuationDistance:[new P(y.ANIMATIONTYPE_FLOAT,"subSurface.tintColorAtDistance",D,()=>1)],thicknessFactor:[new P(y.ANIMATIONTYPE_FLOAT,"subSurface.maximumThickness",D,()=>1)]},KHR_materials_iridescence:{iridescenceFactor:[new P(y.ANIMATIONTYPE_FLOAT,"iridescence.intensity",D,()=>1)],iridescenceIor:[new P(y.ANIMATIONTYPE_FLOAT,"iridescence.indexOfRefraction",D,()=>1)],iridescenceThicknessMinimum:[new P(y.ANIMATIONTYPE_FLOAT,"iridescence.minimumThickness",D,()=>1)],iridescenceThicknessMaximum:[new P(y.ANIMATIONTYPE_FLOAT,"iridescence.maximumThickness",D,()=>1)]}}}},cn={KHR_lights_punctual:{lights:{__array__:{__target__:!0,color:[new he(y.ANIMATIONTYPE_COLOR3,"diffuse",ae,()=>3)],intensity:[new he(y.ANIMATIONTYPE_FLOAT,"intensity",D,()=>1)],range:[new he(y.ANIMATIONTYPE_FLOAT,"range",D,()=>1)],spot:{innerConeAngle:[new he(y.ANIMATIONTYPE_FLOAT,"innerAngle",Ss,()=>1)],outerConeAngle:[new he(y.ANIMATIONTYPE_FLOAT,"angle",Ss,()=>1)]}}}}},dn={nodes:on,materials:ln,cameras:an,extensions:cn},Qe="KHR_animation_pointer";class hn{constructor(e){this.name=Qe,this._loader=e}get enabled(){return this._loader.isExtensionUsed(Qe)}dispose(){this._loader=null}_loadAnimationChannelAsync(e,s,t,n,r){var o;const a=(o=n.target.extensions)===null||o===void 0?void 0:o.KHR_animation_pointer;if(!a)return null;n.target.path!=="pointer"&&U.Warn(`${e}/target/path: Value (${n.target.path}) must be (pointer) when using the ${this.name} extension`),n.target.node!=null&&U.Warn(`${e}/target/node: Value (${n.target.node}) must not be present when using the ${this.name} extension`);const l=`${e}/extensions/${this.name}`,c=a.pointer;if(!c)throw new Error(`${l}: Pointer is missing`);const d=this._parseAnimationPointer(`${l}/pointer`,c);return d?this._loader._loadAnimationChannelFromTargetInfoAsync(e,s,t,n,d,r):(U.Warn(`${l}/pointer: Invalid pointer (${c}) skipped`),null)}_parseAnimationPointer(e,s){if(!s.startsWith("/"))return U.Warn(`${e}: Value (${s}) must start with a slash`),null;const t=s.split("/");t.shift();let n=dn,r=this._loader.gltf,o;for(const a of t){if(n.__array__)n=n.__array__;else if(n=n[a],!n)return null;r=r&&r[a],n.__target__&&(o=r)}return!o||!Array.isArray(n)?null:{target:o,properties:n}}}_.RegisterExtension(Qe,i=>new hn(i));const es="MSFT_audio_emitter";class un{constructor(e){this.name=es,this._loader=e,this.enabled=this._loader.isExtensionUsed(es)}dispose(){this._loader=null,this._clips=null,this._emitters=null}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const s=e[this.name];this._clips=s.clips,this._emitters=s.emitters,p.Assign(this._clips),p.Assign(this._emitters)}}loadSceneAsync(e,s){return _.LoadExtensionAsync(e,s,this.name,(t,n)=>{const r=new Array;r.push(this._loader.loadSceneAsync(e,s));for(const o of n.emitters){const a=p.Get(`${t}/emitters`,this._emitters,o);if(a.refDistance!=null||a.maxDistance!=null||a.rolloffFactor!=null||a.distanceModel!=null||a.innerAngle!=null||a.outerAngle!=null)throw new Error(`${t}: Direction or Distance properties are not allowed on emitters attached to a scene`);r.push(this._loadEmitterAsync(`${t}/emitters/${a.index}`,a))}return Promise.all(r).then(()=>{})})}loadNodeAsync(e,s,t){return _.LoadExtensionAsync(e,s,this.name,(n,r)=>{const o=new Array;return this._loader.loadNodeAsync(n,s,a=>{for(const l of r.emitters){const c=p.Get(`${n}/emitters`,this._emitters,l);o.push(this._loadEmitterAsync(`${n}/emitters/${c.index}`,c).then(()=>{for(const d of c._babylonSounds)d.attachToMesh(a),(c.innerAngle!=null||c.outerAngle!=null)&&(d.setLocalDirectionToMesh(T.Forward()),d.setDirectionalCone(2*N.ToDegrees(c.innerAngle==null?Math.PI:c.innerAngle),2*N.ToDegrees(c.outerAngle==null?Math.PI:c.outerAngle),0))}))}t(a)}).then(a=>Promise.all(o).then(()=>a))})}loadAnimationAsync(e,s){return _.LoadExtensionAsync(e,s,this.name,(t,n)=>this._loader.loadAnimationAsync(e,s).then(r=>{const o=new Array;p.Assign(n.events);for(const a of n.events)o.push(this._loadAnimationEventAsync(`${t}/events/${a.index}`,e,s,a,r));return Promise.all(o).then(()=>r)}))}_loadClipAsync(e,s){if(s._objectURL)return s._objectURL;let t;if(s.uri)t=this._loader.loadUriAsync(e,s,s.uri);else{const n=p.Get(`${e}/bufferView`,this._loader.gltf.bufferViews,s.bufferView);t=this._loader.loadBufferViewAsync(`/bufferViews/${n.index}`,n)}return s._objectURL=t.then(n=>URL.createObjectURL(new Blob([n],{type:s.mimeType}))),s._objectURL}_loadEmitterAsync(e,s){if(s._babylonSounds=s._babylonSounds||[],!s._babylonData){const t=new Array,n=s.name||`emitter${s.index}`,r={loop:!1,autoplay:!1,volume:s.volume==null?1:s.volume};for(let a=0;a<s.clips.length;a++){const l=`/extensions/${this.name}/clips`,c=p.Get(l,this._clips,s.clips[a].clip);t.push(this._loadClipAsync(`${l}/${s.clips[a].clip}`,c).then(d=>{const h=s._babylonSounds[a]=new ft(n,d,this._loader.babylonScene,null,r);h.refDistance=s.refDistance||1,h.maxDistance=s.maxDistance||256,h.rolloffFactor=s.rolloffFactor||1,h.distanceModel=s.distanceModel||"exponential"}))}const o=Promise.all(t).then(()=>{const a=s.clips.map(c=>c.weight||1),l=new _t(s.loop||!1,s._babylonSounds,a);s.innerAngle&&(l.directionalConeInnerAngle=2*N.ToDegrees(s.innerAngle)),s.outerAngle&&(l.directionalConeOuterAngle=2*N.ToDegrees(s.outerAngle)),s.volume&&(l.volume=s.volume),s._babylonData.sound=l});s._babylonData={loaded:o}}return s._babylonData.loaded}_getEventAction(e,s,t,n,r){switch(t){case"play":return o=>{const a=(r||0)+(o-n);s.play(a)};case"stop":return()=>{s.stop()};case"pause":return()=>{s.pause()};default:throw new Error(`${e}: Unsupported action ${t}`)}}_loadAnimationEventAsync(e,s,t,n,r){if(r.targetedAnimations.length==0)return Promise.resolve();const o=r.targetedAnimations[0],a=n.emitter,l=p.Get(`/extensions/${this.name}/emitters`,this._emitters,a);return this._loadEmitterAsync(e,l).then(()=>{const c=l._babylonData.sound;if(c){const d=new ds(n.time,this._getEventAction(e,c,n.action,n.time,n.startOffset));o.animation.addEvent(d),r.onAnimationGroupEndObservable.add(()=>{c.stop()}),r.onAnimationGroupPauseObservable.add(()=>{c.pause()})}})}}_.RegisterExtension(es,i=>new un(i));const ss="MSFT_lod";class fn{constructor(e){this.name=ss,this.order=100,this.maxLODsToLoad=10,this.onNodeLODsLoadedObservable=new W,this.onMaterialLODsLoadedObservable=new W,this._bufferLODs=new Array,this._nodeIndexLOD=null,this._nodeSignalLODs=new Array,this._nodePromiseLODs=new Array,this._nodeBufferLODs=new Array,this._materialIndexLOD=null,this._materialSignalLODs=new Array,this._materialPromiseLODs=new Array,this._materialBufferLODs=new Array,this._loader=e,this.enabled=this._loader.isExtensionUsed(ss)}dispose(){this._loader=null,this._nodeIndexLOD=null,this._nodeSignalLODs.length=0,this._nodePromiseLODs.length=0,this._nodeBufferLODs.length=0,this._materialIndexLOD=null,this._materialSignalLODs.length=0,this._materialPromiseLODs.length=0,this._materialBufferLODs.length=0,this.onMaterialLODsLoadedObservable.clear(),this.onNodeLODsLoadedObservable.clear()}onReady(){for(let e=0;e<this._nodePromiseLODs.length;e++){const s=Promise.all(this._nodePromiseLODs[e]).then(()=>{e!==0&&(this._loader.endPerformanceCounter(`Node LOD ${e}`),this._loader.log(`Loaded node LOD ${e}`)),this.onNodeLODsLoadedObservable.notifyObservers(e),e!==this._nodePromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Node LOD ${e+1}`),this._loadBufferLOD(this._nodeBufferLODs,e+1),this._nodeSignalLODs[e]&&this._nodeSignalLODs[e].resolve())});this._loader._completePromises.push(s)}for(let e=0;e<this._materialPromiseLODs.length;e++){const s=Promise.all(this._materialPromiseLODs[e]).then(()=>{e!==0&&(this._loader.endPerformanceCounter(`Material LOD ${e}`),this._loader.log(`Loaded material LOD ${e}`)),this.onMaterialLODsLoadedObservable.notifyObservers(e),e!==this._materialPromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Material LOD ${e+1}`),this._loadBufferLOD(this._materialBufferLODs,e+1),this._materialSignalLODs[e]&&this._materialSignalLODs[e].resolve())});this._loader._completePromises.push(s)}}loadSceneAsync(e,s){const t=this._loader.loadSceneAsync(e,s);return this._loadBufferLOD(this._bufferLODs,0),t}loadNodeAsync(e,s,t){return _.LoadExtensionAsync(e,s,this.name,(n,r)=>{let o;const a=this._getLODs(n,s,this._loader.gltf.nodes,r.ids);this._loader.logOpen(`${n}`);for(let l=0;l<a.length;l++){const c=a[l];l!==0&&(this._nodeIndexLOD=l,this._nodeSignalLODs[l]=this._nodeSignalLODs[l]||new ue);const d=u=>{t(u),u.setEnabled(!1)},h=this._loader.loadNodeAsync(`/nodes/${c.index}`,c,d).then(u=>{if(l!==0){const f=a[l-1];f._babylonTransformNode&&(this._disposeTransformNode(f._babylonTransformNode),delete f._babylonTransformNode)}return u.setEnabled(!0),u});this._nodePromiseLODs[l]=this._nodePromiseLODs[l]||[],l===0?o=h:(this._nodeIndexLOD=null,this._nodePromiseLODs[l].push(h))}return this._loader.logClose(),o})}_loadMaterialAsync(e,s,t,n,r){return this._nodeIndexLOD?null:_.LoadExtensionAsync(e,s,this.name,(o,a)=>{let l;const c=this._getLODs(o,s,this._loader.gltf.materials,a.ids);this._loader.logOpen(`${o}`);for(let d=0;d<c.length;d++){const h=c[d];d!==0&&(this._materialIndexLOD=d);const u=this._loader._loadMaterialAsync(`/materials/${h.index}`,h,t,n,f=>{d===0&&r(f)}).then(f=>{if(d!==0){r(f);const m=c[d-1]._data;m[n]&&(this._disposeMaterials([m[n].babylonMaterial]),delete m[n])}return f});this._materialPromiseLODs[d]=this._materialPromiseLODs[d]||[],d===0?l=u:(this._materialIndexLOD=null,this._materialPromiseLODs[d].push(u))}return this._loader.logClose(),l})}_loadUriAsync(e,s,t){if(this._nodeIndexLOD!==null){this._loader.log("deferred");const n=this._nodeIndexLOD-1;return this._nodeSignalLODs[n]=this._nodeSignalLODs[n]||new ue,this._nodeSignalLODs[this._nodeIndexLOD-1].promise.then(()=>this._loader.loadUriAsync(e,s,t))}else if(this._materialIndexLOD!==null){this._loader.log("deferred");const n=this._materialIndexLOD-1;return this._materialSignalLODs[n]=this._materialSignalLODs[n]||new ue,this._materialSignalLODs[n].promise.then(()=>this._loader.loadUriAsync(e,s,t))}return null}loadBufferAsync(e,s,t,n){if(this._loader.parent.useRangeRequests&&!s.uri){if(!this._loader.bin)throw new Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);const r=(o,a)=>{const l=t,c=l+n-1;let d=o[a];return d?(d.start=Math.min(d.start,l),d.end=Math.max(d.end,c)):(d={start:l,end:c,loaded:new ue},o[a]=d),d.loaded.promise.then(h=>new Uint8Array(h.buffer,h.byteOffset+t-d.start,n))};return this._loader.log("deferred"),this._nodeIndexLOD!==null?r(this._nodeBufferLODs,this._nodeIndexLOD):this._materialIndexLOD!==null?r(this._materialBufferLODs,this._materialIndexLOD):r(this._bufferLODs,0)}return null}_loadBufferLOD(e,s){const t=e[s];t&&(this._loader.log(`Loading buffer range [${t.start}-${t.end}]`),this._loader.bin.readAsync(t.start,t.end-t.start+1).then(n=>{t.loaded.resolve(n)},n=>{t.loaded.reject(n)}))}_getLODs(e,s,t,n){if(this.maxLODsToLoad<=0)throw new Error("maxLODsToLoad must be greater than zero");const r=new Array;for(let o=n.length-1;o>=0;o--)if(r.push(p.Get(`${e}/ids/${n[o]}`,t,n[o])),r.length===this.maxLODsToLoad)return r;return r.push(s),r}_disposeTransformNode(e){const s=new Array,t=e.material;t&&s.push(t);for(const r of e.getChildMeshes())r.material&&s.push(r.material);e.dispose();const n=s.filter(r=>this._loader.babylonScene.meshes.every(o=>o.material!=r));this._disposeMaterials(n)}_disposeMaterials(e){const s={};for(const t of e){for(const n of t.getActiveTextures())s[n.uniqueId]=n;t.dispose()}for(const t in s)for(const n of this._loader.babylonScene.materials)n.hasTexture(s[t])&&delete s[t];for(const t in s)s[t].dispose()}}_.RegisterExtension(ss,i=>new fn(i));const ts="MSFT_minecraftMesh";class _n{constructor(e){this.name=ts,this._loader=e,this.enabled=this._loader.isExtensionUsed(ts)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,s,t){return _.LoadExtraAsync(e,s,this.name,(n,r)=>{if(r){if(!(t instanceof V))throw new Error(`${n}: Material type not supported`);const o=this._loader.loadMaterialPropertiesAsync(e,s,t);return t.needAlphaBlending()&&(t.forceDepthWrite=!0,t.separateCullingPass=!0),t.backFaceCulling=t.forceDepthWrite,t.twoSidedLighting=!0,o}return null})}}_.RegisterExtension(ts,i=>new _n(i));const ns="MSFT_sRGBFactors";class mn{constructor(e){this.name=ns,this._loader=e,this.enabled=this._loader.isExtensionUsed(ns)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,s,t){return _.LoadExtraAsync(e,s,this.name,(n,r)=>{if(r){if(!(t instanceof V))throw new Error(`${n}: Material type not supported`);const o=this._loader.loadMaterialPropertiesAsync(e,s,t),a=t.getScene().getEngine().useExactSrgbConversions;return t.albedoTexture||t.albedoColor.toLinearSpaceToRef(t.albedoColor,a),t.reflectivityTexture||t.reflectivityColor.toLinearSpaceToRef(t.reflectivityColor,a),o}return null})}}_.RegisterExtension(ns,i=>new mn(i));const Bs="ExtrasAsMetadata";class pn{_assignExtras(e,s){if(s.extras&&Object.keys(s.extras).length>0){const t=e.metadata=e.metadata||{},n=t.gltf=t.gltf||{};n.extras=s.extras}}constructor(e){this.name=Bs,this.enabled=!0,this._loader=e}dispose(){this._loader=null}loadNodeAsync(e,s,t){return this._loader.loadNodeAsync(e,s,n=>{this._assignExtras(n,s),t(n)})}loadCameraAsync(e,s,t){return this._loader.loadCameraAsync(e,s,n=>{this._assignExtras(n,s),t(n)})}createMaterial(e,s,t){const n=this._loader.createMaterial(e,s,t);return this._assignExtras(n,s),n}}_.RegisterExtension(Bs,i=>new pn(i));
